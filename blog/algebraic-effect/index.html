<!DOCTYPE html><html lang="zh-CN"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/webp" href="/_astro/logo.zcK9pHo2_CGMl6.webp"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Zero Calorie Drink Shop" href="https://lhcfl.github.io/rss.xml"><meta name="generator" content="Astro v5.18.0"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev"><link rel="preconnect" href="https://ik.imagekit.io" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://lhcfl.github.io/blog/algebraic-effect/"><!-- Primary Meta Tags --><title>简单接触 Algebraic Effects ⬝ Zero Calorie Drink Shop</title><meta name="title" content="简单接触 Algebraic Effects ⬝ Zero Calorie Drink Shop"><meta name="description" content="TL;DR：简而言之，代数效应是一种机制，允许在不破坏函数式编程纯度的前提下，更加结构化和组合化地处理副作用。
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://lhcfl.github.io/blog/algebraic-effect/"><meta property="og:title" content="简单接触 Algebraic Effects ⬝ Zero Calorie Drink Shop"><meta property="og:description" content="TL;DR：简而言之，代数效应是一种机制，允许在不破坏函数式编程纯度的前提下，更加结构化和组合化地处理副作用。
"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lhcfl.github.io/blog/algebraic-effect/"><meta property="twitter:title" content="简单接触 Algebraic Effects ⬝ Zero Calorie Drink Shop"><meta property="twitter:description" content="TL;DR：简而言之，代数效应是一种机制，允许在不破坏函数式编程纯度的前提下，更加结构化和组合化地处理副作用。
"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.Bk5rygI5.js"></script><link rel="stylesheet" href="/_astro/_static_page_.D_hEsS3a.css">
<link rel="stylesheet" href="/_astro/_static_page_.CVCZMPgC.css">
<link rel="stylesheet" href="/_astro/_static_page_.DUMM9sSp.css"><script type="module" src="/_astro/page.B5CPI74E.js"></script></head> <body class="overflow-y-scroll has-sidebar"> <div class="app bg-surface text-content md:flex lg:justify-center max-w-full">  <header class="flex-[0_0_auto] print:hidden flex sticky top-0 font-sans max-md:items-center max-md:justify-between max-md:w-full max-md:h-15 max-md:z-50 max-md:bg-surface max-md:px-2 max-lg:w-20 md:flex-col md:h-screen md:text-lg md:p-4 md:shrink-0 md:grow-0 max-md:border-b md:border-r border-base-300"> <a href="/" class="flex flex-col items-center gap-2 lg:mt-4"> <div class="nav-site-avatar avatar w-10 md:w-12 lg:hidden"> <img src="/_astro/logo.zcK9pHo2_CGMl6.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="100" height="100"> </div> <div class="nav-site-avatar avatar max-lg:hidden w-40"> <img src="/_astro/logo.zcK9pHo2_ZuqEup.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="512" height="512"> </div> <span class="nav-site-title text-lg font-bold max-lg:hidden">Zero Calorie Drink Shop</span> </a> <nav class="links flex items-center gap-2 text-lg md:flex-col md:pt-6 md:text-2xl lg:text-base"> <a href="/" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Home" data-path-name="blog/algebraic-effect/" data-href-base="/"> <svg width="1em" height="1em" data-icon="mingcute:home-3-line">   <symbol id="ai:mingcute:home-3-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.772 2.688a2 2 0 0 1 2.317-.099l.139.1l8.384 6.52c.721.561.37 1.692-.499 1.785l-.116.006H20v8a2 2 0 0 1-1.85 1.995L18 21H6a2 2 0 0 1-1.994-1.85L4 19v-8h-.997C2.09 11 1.671 9.892 2.3 9.285l.088-.076zM12 4.267L5.625 9.225c.229.185.375.468.375.785V19h3v-5a3 3 0 1 1 6 0v5h3v-8.99c0-.317.146-.6.375-.785zM12 13a1 1 0 0 0-1 1v5h2v-5a1 1 0 0 0-1-1"/></g></symbol><use href="#ai:mingcute:home-3-line"></use>  </svg> <span class="max-lg:hidden"> Home </span> </a><a href="/archives" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Archives" data-path-name="blog/algebraic-effect/" data-href-base="archives"> <svg width="1em" height="1em" data-icon="mingcute:archive-line">   <symbol id="ai:mingcute:archive-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16.586 3A2 2 0 0 1 18 3.586L20.414 6A2 2 0 0 1 21 7.414V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7.414A2 2 0 0 1 3.586 6L6 3.586A2 2 0 0 1 7.414 3zM19 9H5v10h14zm-7 1a1 1 0 0 1 1 1v3.186l.414-.414a1 1 0 1 1 1.414 1.414l-2.12 2.121a1 1 0 0 1-1.415 0l-2.121-2.121a1 1 0 1 1 1.414-1.414l.414.414V11a1 1 0 0 1 1-1m4.586-5H7.414l-2 2h13.172z"/></g></symbol><use href="#ai:mingcute:archive-line"></use>  </svg> <span class="max-lg:hidden"> Archives </span> </a><a href="/notes/1" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Notes" data-path-name="blog/algebraic-effect/" data-href-base="notes"> <svg width="1em" height="1em" data-icon="mingcute:notebook-line">   <symbol id="ai:mingcute:notebook-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M17 2c1.598 0 3 1.3 3 3v13c0 1.7-1.4 3-3 3H6c-1.054 0-2-.95-2-2V4c0-1.054.95-2 2-2zm0 2h-7v15h7c.513 0 1-.39 1-1V5c0-.513-.49-1-1-1M8 4H6v15h2z"/></g></symbol><use href="#ai:mingcute:notebook-line"></use>  </svg> <span class="max-lg:hidden"> Notes </span> </a><a href="/tags" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Tags" data-path-name="blog/algebraic-effect/" data-href-base="tags"> <svg width="1em" height="1em" data-icon="mingcute:tag-2-line">   <symbol id="ai:mingcute:tag-2-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.238 4.827a3 3 0 0 1 2.122.878l6.485 6.486a3 3 0 0 1 0 4.242l-4.243 4.243a3 3 0 0 1-4.242 0l-6.486-6.485a3 3 0 0 1-.878-2.122V7.327a2.5 2.5 0 0 1 2.5-2.5zm0 2H5.496a.5.5 0 0 0-.5.5v4.742a1 1 0 0 0 .292.707l6.486 6.486a1 1 0 0 0 1.414 0l4.243-4.243a1 1 0 0 0 0-1.414L10.945 7.12a1 1 0 0 0-.707-.293M7.531 9.362a1.5 1.5 0 1 1 2.121 2.122a1.5 1.5 0 0 1-2.121-2.122M11.652 2a3 3 0 0 1 2.122.878l7.192 7.193a1 1 0 0 1-1.414 1.414L12.36 4.29a1 1 0 0 0-.708-.29H7a1 1 0 0 1 0-2z"/></g></symbol><use href="#ai:mingcute:tag-2-line"></use>  </svg> <span class="max-lg:hidden"> Tags </span> </a><a href="/about" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="About" data-path-name="blog/algebraic-effect/" data-href-base="about"> <svg width="1em" height="1em" data-icon="mingcute:user-3-line">   <symbol id="ai:mingcute:user-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M12 13c2.396 0 4.575.694 6.178 1.672c.8.488 1.484 1.064 1.978 1.69c.486.615.844 1.351.844 2.138c0 .845-.411 1.511-1.003 1.986c-.56.45-1.299.748-2.084.956c-1.578.417-3.684.558-5.913.558s-4.335-.14-5.913-.558c-.785-.208-1.524-.506-2.084-.956C3.41 20.01 3 19.345 3 18.5c0-.787.358-1.523.844-2.139c.494-.625 1.177-1.2 1.978-1.69C7.425 13.695 9.605 13 12 13m0 2c-2.023 0-3.843.59-5.136 1.379c-.647.394-1.135.822-1.45 1.222c-.324.41-.414.72-.414.899c0 .122.037.251.255.426c.249.2.682.407 1.344.582C7.917 19.858 9.811 20 12 20c2.19 0 4.083-.143 5.4-.492c.663-.175 1.096-.382 1.345-.582c.218-.175.255-.304.255-.426c0-.18-.09-.489-.413-.899c-.316-.4-.804-.828-1.451-1.222C15.843 15.589 14.023 15 12 15m0-13a5 5 0 1 1 0 10a5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6"/></g></symbol><use href="#ai:mingcute:user-3-line"></use>  </svg> <span class="max-lg:hidden"> About </span> </a><a href="/links" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Friends" data-path-name="blog/algebraic-effect/" data-href-base="links"> <svg width="1em" height="1em" data-icon="mingcute:link-3-line">   <symbol id="ai:mingcute:link-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M1 10a5 5 0 0 1 5-5h6a5 5 0 0 1 0 10a1 1 0 1 1 0-2a3 3 0 1 0 0-6H6a3 3 0 0 0-.75 5.906a1 1 0 0 1-.5 1.936A5 5 0 0 1 1 10m11 1a3 3 0 1 0 0 6h6a3 3 0 0 0 .75-5.905a1 1 0 0 1 .5-1.937A5.002 5.002 0 0 1 18 19h-6a5 5 0 0 1 0-10a1 1 0 1 1 0 2"/></g></symbol><use href="#ai:mingcute:link-3-line"></use>  </svg> <span class="max-lg:hidden"> Friends </span> </a><a href="/search" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Search" data-path-name="blog/algebraic-effect/" data-href-base="search"> <svg width="1em" height="1em" data-icon="mingcute:search-3-line">   <symbol id="ai:mingcute:search-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.5 4a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13M2 10.5a8.5 8.5 0 1 1 15.176 5.262l3.652 3.652a1 1 0 0 1-1.414 1.414l-3.652-3.652A8.5 8.5 0 0 1 2 10.5M9.5 7a1 1 0 0 1 1-1a4.5 4.5 0 0 1 4.5 4.5a1 1 0 1 1-2 0A2.5 2.5 0 0 0 10.5 8a1 1 0 0 1-1-1"/></g></symbol><use href="#ai:mingcute:search-3-line"></use>  </svg> <span class="max-lg:hidden"> Search </span> </a> </nav> <div class="navbar-end md:flex-grow md:flex md:items-baseline-last md:justify-center"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="18tXJb" component-url="/_astro/DarkLightToggle.DYSrvQvV.js" component-export="default" renderer-url="/_astro/client.svelte.DN8iM4l6.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;DarkLightToggle&quot;,&quot;value&quot;:true}" await-children><!--[--><button class="i-mingcute:moon-stars-line" aria-label="toggle theme"></button><!--]--><!--astro:end--></astro-island> </div> </header> <div class="main-and-footer__outer-container max-w-full min-h-screen overflow-x-hidden flex flex-grow flex-shrink flex-basis-180 xl:grow-0 at-md:justify-center"> <div class="flex flex-col w-full max-w-180"> <main class="grow relative p-4 md:pt-6 undefined">  <article> <h1 class="page-title text-3xl font-bold"> <span class="inline-flex items-center gap-1">   <span>简单接触 Algebraic Effects</span>  </span> </h1> <div> <div class="markdown-body is-detailed"> <p lang="zh">TL;DR：简而言之，代数效应是一种机制，允许在不破坏函数式编程纯度的前提下，更加结构化和组合化地处理副作用。</p>
<!-- more -->
<h3 id="引入">引入</h3>
<p lang="en">本学期的 Rust 课程项目大作业是写一个 git。总而言之，Git 有一个对象存储系统，允许将 <code>Tree</code> 和 <code>Blob</code> 和 <code>Commit</code> 作为三种不同的 <code>Object</code> 存储在 <code>.git/objects/[object hash]</code> 这个文件中。</p>
<p lang="zh">作为一个浸淫于实践需求中的人，你很容易看出来，git 项目的几乎所有东西都依赖实现计算好的 <code>.git</code> 文件夹的位置，所以我们可以抽象一个数据类型</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /// .git dir for the repository</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> root</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> PathBuf</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">这很好。然后你发现，我们需要带着这个 <code>Repository</code> 的引用（指针）到处跑，所有需要从磁盘中读取和保存的场景我们全都需要 <code>Repository</code> 提供的 <code>root</code> 路径。一个不太熟练（ <del>不太被腌入味了</del> ）的人可能会写出</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">impl</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> save</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> io</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">...</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> load</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> io</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">Self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">...</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">这当然好！……但是有没有可能，到处都要显式传递 repo 这件事显得很繁琐很增加键盘输入量呢？</p>
<p lang="zh">所以你脑袋一拍，我们构造一个数据结构吧，</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    inner</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">impl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> new</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, inner</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Self</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> repo, inner </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /// Wrap the storeable object with the repository path</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> wrap</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">To</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, inner</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> To</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">To</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            inner,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /// unpack self, and get the inner object</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> unwrap</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">inner</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    /// A `WithRepo&#x3C;T>` is actually a functor, you can apply a T -> U function to `WithRepo&#x3C;T>` to get` WithRepo&#x3C;U>` by mapping it.</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">F</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">U</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, f</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> F</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">r</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">U</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    where</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        F</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> FnOnce</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> U</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            repo</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            inner</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">inner</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en"><code>WithRepo</code> 是一个 <a href="https://www.adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">Functor</a>，它有一个 map 方法，在 Haskell 里是 <code>fmap</code> ，用来把一个 <code>a -> b</code> 的函数 apply 到 <code>WithRepo&#x3C;a></code> 上得到一个 <code>WithRepo&#x3C;b></code></p>
<p lang="zh">现在好多了，我们可以直接在 <code>WithRepo&#x3C;Object></code> 之类的东西上做文章，<code>Repository</code> 的指针在被创建的时候被包了进去作为<strong>依赖</strong>。我们可以写出这样优雅的代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> repo </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Repository</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// stage: WithRepo&#x3C;'_, MutableTree></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> stage </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> repo</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stage</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into_muter</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> path </span><span style="color:#D73A49;--shiki-dark:#F97583">in</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">paths </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> path </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> env</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">current_dir</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">join</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    stage</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">add_path</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/// impl&#x3C;'a> WithRepo&#x3C;'a, MutableTree> pub fn freeze(self) -> WithRepo&#x3C;'a, Tree></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">stage</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">freeze</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">map</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Stage</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">save</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<p lang="zh"><code>repo</code> 这个参数只在最开始被使用，之后的 stage 以及 <code>WithRepo&#x3C;'a, MutableTree></code> 这个东西的所有内部用到的东西都很自然地被提供了 <code>repo</code> 这个上下文，因此 <code>save</code> 不需要额外的参数指明 <code>.git</code> 所在文件夹的路径，直观而优雅。</p>
<p lang="zh">问题出在 <code>add_path</code> 里面。<code>add_path</code> 在文件系统中找到路径，测试它是文件还是文件夹，如果是文件把它读取并存储为 <code>Blob</code>，如果是文件夹把它 dump 成一个 <code>Tree</code> 并存储。</p>
<p>这是我们的代码。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> add_file</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, path</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> io</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> filename </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> path</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">file_name</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ok_or</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">io</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Error</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">new</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            io</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ErrorKind</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">InvalidInput</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            format!</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"file name is invalid: {}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, path</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">display</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">to_string_lossy</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug_util</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Adding file"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ctnt </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fs</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> blob </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Blob</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        String</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">from_utf8</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ctnt</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">map</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#6F42C1;--shiki-dark:#B392F0">str</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">unwrap_or_else</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8">e</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into_bytes</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> blob </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">wrap</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">blob</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">save_object </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        blob</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">save</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> line </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> TreeLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        kind</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> TreeLineKind</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        name</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> filename</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">to_string</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        sha1</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> blob</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">sha1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#24292E;--shiki-dark:#E1E4E8">data</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">filename</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">to_string</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, line</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">问题所在是什么呢？它很难测试。当然你可以直接 <code>fs::tmp_dir()</code> 直接在系统里创一个临时文件夹，然后灌一些临时文件进去，但是这当然不够优雅。更何况，<strong>副作用</strong> 不止有 文件 IO 一种。还有控制台 IO。如果你要测试 <code>git commit</code> 这个命令，希望它产生一个正确的屏幕输出，怎么做到？只能将 <code>println!</code> 又换成自己的宏，也做参数传进去，为了保持完美的可测试性和可组合性，久而久之你的函数可能会变成这样：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">impl</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GitAdd</span><span style="color:#D73A49;--shiki-dark:#F97583"> for</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> WithRepo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WithFs</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WithConsole</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WithService1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WithService2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">.....</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span></code></pre>
<p lang="zh">这完全就是地狱……于是人们发明了 DI ： 依赖注入</p>
<p lang="zh"><del>但我们这里不是讲依赖注入，所以请看代数效应</del></p>
<h3 id="effectside-effect">Effect，Side Effect</h3>
<p lang="st">要讲 Algebraic Effect 让我们先讲讲 Haskell 的 IO Monad。写过 Haskell 的人都知道，Haskell 里面的 putStrLn 是</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="haskell"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">putStrLn</span><span style="color:#D73A49;--shiki-dark:#F97583"> ::</span><span style="color:#D73A49;--shiki-dark:#F97583"> String</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> IO</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">你会注意到一个看上去很像 Rust 的 <code>io::Result</code> 的 Monad，也就是 <code>IO</code>。但 Haskell 与 Rust 不一样的一个地方是，IO Monad 并不是“保存”了执行结果，而是“说明”了执行顺序。在 Rust 中，如果你写一个 <code>fs::write(...)</code> 得到了一个 <code>io::Result&#x3C;T></code>，这个副作用真的已经被执行了，返回的只是成功与否；而 Haskell 中返回的是这个副作用本身。它可能在未来的某一个被某个 <code>IO a -> a</code> 的东西执行，这时候才真正执行了副作用；但在此之前它只是一个顺序。</p>
<p lang="zh">对于一个完全没有什么函数式经验的人来说这句话可能很难理解。让我们引用一下 <a href="https://zhuanlan.zhihu.com/p/1892390136857228808">https://zhuanlan.zhihu.com/p/1892390136857228808</a> <a href="https://entropicthoughts.com/haskell-procedural-programming">Haskell：优秀的过程式语言</a></p>
<blockquote>
<p><strong>副作用作为一等公民 (first class values)</strong></p>
<p lang="zh">在 Haskell 中，有副作用的计算被当作一等值。这意味着我们可以将它们存储在变量或数据结构中以备后用。有一个 Haskell 函数：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="haskell"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">randomRIO</span><span style="color:#D73A49;--shiki-dark:#F97583"> ::</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">Int</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">Int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> IO</span><span style="color:#D73A49;--shiki-dark:#F97583"> Int</span></span></code></pre>
<p lang="zh">当传入两个整数作为参数时，它会在这两个数之间随机选出一个整数。我们可以将对这个函数的调用放入一个列表中，像这样：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="haskell"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">some_dice </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> randomRIO</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">6</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, randomRIO</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">6</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span></code></pre>
<p lang="zh">这是一个包含两次对 <code>randomRIO</code> 调用的列表。令非 Haskell 程序员感到惊讶的是，当这个列表被创建时，并不会生成任何随机数。来自其他编程语言的我们习惯于副作用（如随机生成）在调用带有副作用的函数时立即执行。[6]</p>
<p lang="zh">我们可以在列表中加入更多的随机生成操作：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="haskell"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">more_dice </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> some_dice </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> randomRIO</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">6</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span></code></pre>
<p lang="zh">依然不会生成随机数。我们可以任意操作这个列表，依旧不会生成随机数。</p>
<p lang="zh">需要明确的是，<code>randomRIO</code> 函数确实可能会被调用[7]。而当它被调用时，它返回的值类型是 <code>IO Int</code>。只不过这个值并不是一个整数。如果要说的话，我们可以把它看作是一组最终能获得整数的指令。它并非实际的整数，而是一个封装了副作用的对象。当这个副作用对象执行时，会产生一个随机整数，但这个对象本身仅仅描述了计算过程，并不是一个整数。</p>
<p lang="zh">换句话说，在 Haskell 中，仅仅调用一个带有副作用的函数是不足以执行其副作用的。当我们调用一个带副作用的函数时，它产生了一个封装了副作用的对象，这个对象可以在未来某个时刻被执行，从而产生副作用的结果[8]。</p>
</blockquote>
<p lang="zh">如果它难以理解，不妨想象一下你在写一个前端项目。—— 是的，<code>Promise</code> 也（几乎）是一个 Monad。关于 Monad 是什么，可以看看我的 <a href="/2025/03/27/learn-monads/">这篇文章</a></p>
<p lang="zh">Promise 和 IO 的共同点是，它们都封装了一个<strong>执行顺序</strong>。有经验的前端开发者一眼就看得出来</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">fetch</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"https://example.com/example-api"</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> res.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">json</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    balabala</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    dosomething</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fetch</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">foo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    bar</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<p lang="zh">Promise 提供了一套很好的接口，允许我们顺序地写出一些先后发生的事情，而无需关心回调的细节。在这里，所有的 <code>.then</code> 函数都不是马上执行的：它们只有在前一个 Promise fulfilled 的时候才会被自动地回调。因此，你可能会看到这样的代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> runDecorateResult</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">promise</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> promise.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> foo</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> bar</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> decorated</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> runDecorateResult</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  sendSomeApi</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> baz</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<p lang="nb">这里，<code>sendSomeApi().then((res) => baz(res))</code> 创建了一个<strong>顺序</strong>，先 <code>sendSomeApi</code>，再基于结果 <code>baz</code>。然后 <code>runDecorateResult</code> 又进一步的<strong>在顺序上</strong>而非结果上添加了新的顺序，先 <code>foo</code> 再 <code>bar</code>。这些与值无关，JS 引擎和 Promise 内部跑的循环将会<strong>执行这个顺序</strong>。</p>
<p lang="zh">或者我们这样说：<strong><code>then</code> 允许我们把顺序组合起来，交给某个特定的无关的执行者。</strong></p>
<h3 id="algebraic-effect">Algebraic Effect</h3>
<p lang="zh">理解了 Monad 如何组合副作用之后，我们就可以理解 Algebraic Effect 了。</p>
<p lang="zh">代数效应的核心思想是：<strong>我们可以把副作用进行传递和组合</strong>。让我们考察几种最常见的效应：</p>
<ul lang="zh">
<li><code>total</code>: 没有任何效应对应数学意义上的全函数，总是能给定相同输入返回一个相同输出。</li>
<li><code>exception</code>: （后面在 Koka 中叫 <code>exn</code>） 可能抛出异常</li>
<li><code>div</code>: 可能不停机，也就是发散 （divergence）</li>
<li><code>ndet</code>: 非决定性的函数，比如 <code>random</code>，对于相同输入可能返回多个不同的值</li>
<li><code>io</code>: 这是最差的效应，这意味着程序可以引发异常、不终止、非确定性、读取和写入堆以及执行任何输入/输出作用。</li>
</ul>
<p lang="zh"><code>exn</code> 和 <code>div</code> 的组合是 pure，直接对应于 Haskell 的纯度概念。一个函数可能具有多个效应。比如如下 Koka 代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// combine-effects: forall&#x3C;a> () -> &#x3C;pure,ndet> a</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> combine</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">effects</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> srandom</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6A737D;--shiki-dark:#6A737D">// non-deterministic</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  throw</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"oops"</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">         </span><span style="color:#6A737D;--shiki-dark:#6A737D">// exception raising</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  combine</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">effects</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">     </span><span style="color:#6A737D;--shiki-dark:#6A737D">// and non-terminating</span></span></code></pre>
<p lang="fr">分配给 <code>combine-effects</code> 的效应是 <code>ndet</code>、<code>div</code> 和 <code>exn</code>。</p>
<p lang="en">algebraic effects 的做法是，我们把副作用抽象为 <strong>操作符（operations）</strong> 和 <strong>处理器（handlers）</strong> 两部分。以最经典的一种 effect 也就是异常为例：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">effect raise</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  ctl </span><span style="color:#6F42C1;--shiki-dark:#B392F0">raise</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> msg : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">a</span></span></code></pre>
<p lang="en">这定义了一个 effect 类型 raise 和一个 <code>(msg : string) -> raise a</code> 类型的 operation <code>raise</code>。声明 effect 的签名后，我们已经可以使用这些 operations 了：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> safe</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">divide</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, y : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">raise</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> int</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  if</span><span style="color:#E36209;--shiki-dark:#FFAB70"> y=</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> then </span><span style="color:#6F42C1;--shiki-dark:#B392F0">raise</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"div-by-zero"</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> y</span></span></code></pre>
<p lang="zh">其中我们看到 safe-divide 函数获得了 raise 效应（因为我们在函数体内使用了 raise 操作符）。这样的效应类型意味着我们只能在处理 raise 的上下文中 evaluate 这个函数（换句话说，它是 “动态绑定”的，或者我们 “具有 raise 能力”） 的上下文。</p>
<p lang="zh">我们可以通过为 raise 给出具体定义来处理这种效果。例如，我们可能总是返回一个默认值：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> raise</span><span style="color:#D73A49;--shiki-dark:#F97583">-const</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    ctl </span><span style="color:#6F42C1;--shiki-dark:#B392F0">raise</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005CC5;--shiki-dark:#79B8FF">42</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 哦，宇宙的终极答案是 42</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  8</span><span style="color:#D73A49;--shiki-dark:#F97583"> +</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> safe</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">divide</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// 返回 42 而不是 50</span></span></code></pre>
<p lang="zh">调用 <code>raise-const()</code> 的计算结果为 42，不是 50。当调用 <code>raise</code> 时（在 <code>safe-divide</code> 中），它将 <code>yield</code> 于其最内层的 handler，展开堆栈，然后才 evaluate 操作符的定义 – 这个例子中，只是从定义 handler 的点直接返回 42。现在我们可以看到为什么它被称为 <code>ctl operator</code> （控制操作符），因为 raise 改变了常规的线性控制流，并从原始调用点直接 yield 到其最内层的处理程序。还要注意 <code>raise-const</code> 现在又是一个 <code>total</code> function 了，handler 抵消了 raise 的效果。</p>
<p lang="zh">看到 effect 的写法后，我觉得你应该大体就能理解代数效应解决了什么了。</p>
<blockquote>
<p lang="fr">作者：Malcolm Yu
链接：<a href="https://www.zhihu.com/question/300095154/answer/1744221759">https://www.zhihu.com/question/300095154/answer/1744221759</a>
来源：知乎</p>
<p lang="zh">假如我们有这样一段代码，其主要目的是进行一大段精妙的运算：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#D73A49;--shiki-dark:#F97583"> function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> infoId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> id; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> info</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">infoId</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，与 server 通信</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> dataId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> info.dataId; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> data</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">dataId</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，非幂等操作</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> data.finalCalcData; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">尽管运算逻辑很优美，但美中不足的是有两段副作用，导致它不能成为一个干净的纯函数被单元测试。而且这里会导致严重的逻辑耦合：『做什么』与『怎么做』没有拆的很干净：</p>
<ul lang="zh">
<li>你的一大段计算逻辑是在处理「做什么」；</li>
<li>两个副作用更关心「怎么做」：比如线上是接口调用，单测里是 mock 数据直接怼；</li>
<li>但是由于这两块副作用代码，导致整个糅杂的逻辑都无法复用。</li>
</ul>
<p lang="zh">看到这里你可能会一拍大腿：函数在 JS 里不是一等公民嘛，我直接把两个副作用传进来不就行了？</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="javascript"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">async</span><span style="color:#D73A49;--shiki-dark:#F97583"> function</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">getInfo</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">getData</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> infoId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> id; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> info</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> await</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">infoId</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，与 server 通信</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> dataId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> info.dataId; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> data</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">dataId</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，非幂等操作</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> data.finalCalcData; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">是的，这样确实可以复用，但还有一个叫函数染色的问题没有解决：明明是一大段干净的同步运算逻辑，因为 <code>getInfo</code> 是异步的，导致整个函数都得加个 <code>async</code>。而且很有可能在我单元测试里，这个 <code>getInfo</code> 是直接同步取内存数据，还得因此弄个 <code>Promise</code>……</p>
</blockquote>
<p lang="zh">没错，代数效应就能非常简单的解决这个问题。比如这个 biz，我们把它在 Koka 中写成</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">effect useInfoData</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span></span></code></pre>
<p>然后我们就可以在 <code>biz</code> 里面使用 <code>getInfo</code> 和 <code>getData</code> 了：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">useInfoData</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> data</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> infoId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> id; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> info </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">infoId</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，与 server 通信</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> dataId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6A737D;--shiki-dark:#6A737D"> /* do some calc */</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> info.dataId; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#D73A49;--shiki-dark:#F97583"> data</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">dataId</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 副作用，非幂等操作</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  /* do some calc */</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  data</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.finalCalcData </span><span style="color:#6A737D;--shiki-dark:#6A737D">// 这里可以理解为是一大段计算逻辑</span></span></code></pre>
<p lang="zh">你说 getInfo 是 <code>async</code> 的，那咋了？在代数效应里，这种函数染色可以直接被削去：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> production_run_biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      some_async_task</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">fn</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">resume</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      some_sync_task</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test_run_biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getInfo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      some_sync_test_task</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getData</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      some_sync_test_task</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  biz</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">这样，我们复用了一大段精妙的逻辑 <code>biz</code>，而且没有函数染色的问题。我们可以在 <code>production_run_biz</code> 里面使用异步的 <code>getInfo</code> 和 <code>getData</code>，而在 <code>test_run_biz</code> 里面使用同步的 <code>getInfo</code> 和 <code>getData</code>。这就是代数效应的魅力所在。</p>
<p lang="zh">代数效应允许我们把副作用抽象成操作符和处理器，允许我们在不改变函数签名的情况下，使用不同的副作用实现。这样，我们就可以在测试中使用不同的副作用实现，而不需要修改函数本身。</p>
<p lang="zh">现在回到最初的场景：代数作用如何解决我们之前提到的 <code>WithRepo</code>, <code>fs</code>, <code>console</code> 的问题呢？</p>
<p lang="zh">我们可以把 <code>fs</code> 和 <code>console</code> 抽象成代数效应：（下面的代码是伪代码，不是 Koka 真的能运行的程序）</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">effect fs</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> read</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">bytes</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> write</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">data</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">bytes</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> remove</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> exists</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">bool</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  ....</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">effect console</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> log</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> warn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> info</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">unit</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  ....</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">effect repo</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  val</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> path : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  ..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> production</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">action: </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fs|e</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">e</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> read</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> write</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path, </span><span style="color:#D73A49;--shiki-dark:#F97583">data</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path, </span><span style="color:#D73A49;--shiki-dark:#F97583">data</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> remove</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> exists</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exists</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    ..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  action</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">action: </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fs|e</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">e</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> read</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> write</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path, </span><span style="color:#D73A49;--shiki-dark:#F97583">data</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path, </span><span style="color:#D73A49;--shiki-dark:#F97583">data</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> remove</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> exists</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.fs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exists</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">path</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    ..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  action</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> production</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">console</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">action: </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">console|e</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">e</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> log</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> warn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">warn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> info</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> std.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">info</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    ..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  action</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">console</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">action: </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">console|e</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">e</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with handler</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> log</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> warn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test.console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">warn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> info</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">msg</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    ..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  action</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">..</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span></code></pre>
<p lang="zh">最终我们可以非常自然地组合出我们真正需要的 git_add 函数：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="koka"><code><span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> some_perfect_git_add_logic</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">files: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fs</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">console</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo unit</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  var</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> stage :</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> repo.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stage</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  ....</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  stage.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">save</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> git_add</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with production</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with production</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">console</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with production</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  some_perfect_git_add_logic</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test_git_add</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with test</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with test</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">console</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  with test</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">repo</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  some_perfect_git_add_logic</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="fr">同时方便了 production 和 test，也让 git add 的 logic 变得可以充分的复用了起来。</p> </div>
    <div class="divider"></div>
    <p class="post-meta flex flex-wrap items-center gap-2 text-base-content/60"> <span class="date flex gap-1 items-center shrink-0 text-sm"> <svg width="1em" height="1em" data-icon="mingcute:calendar-2-line">   <symbol id="ai:mingcute:calendar-2-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16 3a1 1 0 0 1 1 1v1h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2V4a1 1 0 0 1 2 0v1h6V4a1 1 0 0 1 1-1M8 7H5v2h14V7h-3zm-3 4v8h14v-8zm2 2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H16a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z"/></g></symbol><use href="#ai:mingcute:calendar-2-line"></use>  </svg> <time datetime="2025-05-12T23:22:14.000Z"> 2025/05/12 </time> </span> <span class="flex flex-wrap max-w-full overflow-hidden text-ellipsis gap-2"> <a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Code/"> <svg width="1em" height="1em" class="shrink-0" data-icon="mingcute:tag-line">   <symbol id="ai:mingcute:tag-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.537 2.164a3 3 0 0 1 2.244.727l.15.14l7.822 7.823a3 3 0 0 1 .135 4.098l-.135.144l-5.657 5.657a3 3 0 0 1-4.098.135l-.144-.135L3.03 12.93a3 3 0 0 1-.878-2.188l.011-.205l.472-5.185a3 3 0 0 1 2.537-2.695l.179-.021zm.308 1.989l-.127.003l-5.185.472a1 1 0 0 0-.888.787l-.017.118l-.472 5.185a1 1 0 0 0 .206.703l.083.095l7.823 7.823a1 1 0 0 0 1.32.083l.094-.083l5.657-5.657a1 1 0 0 0 .083-1.32l-.083-.094l-7.823-7.823a1 1 0 0 0-.671-.292M7.317 7.318a3 3 0 1 1 4.243 4.243a3 3 0 0 1-4.243-4.243m2.829 1.414a1 1 0 1 0-1.415 1.414a1 1 0 0 0 1.415-1.414"/></g></symbol><use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Code</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Programing Language/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Programing Language</span> </a> </span> </p>
    <div class="mt-8 border-t border-t-base-300 pt-4"><div class="comments-container"> <div id="gitalk-mainEl" data-uid="blog:algebraic-effect"></div> </div> <script type="module" src="/_astro/GitalkComment.astro_astro_type_script_index_0_lang.C8Q7p-gl.js"></script> </div> </div> </article>  </main> <footer> <div class="text-center mb-4 markdown-body font-sans text-xs!"> <p>
&copy; 2026 Linca. All rights reserved.
</p> <p>
开业 <span id="BLOG_DAYS" data-first-date="1538918349000">2700</span> 天里，写下了 56 篇博客，2 篇页面，9 篇杂记，357221 字符。
</p> <p>
Powered by
<a href="https://astro.build" target="_blank" rel="noopener noreferrer">
Astro
</a>
and
<a href="https://github.com/Lhcfl/astro-theme-krypton2" target="_blank" rel="noopener noreferrer">
Krypton 2
</a>.
</p> </div> </footer> <script type="module">document.addEventListener("astro:page-load",()=>{const t=document.getElementById("BLOG_DAYS");if(t){const e=Date.now()-Number(t.dataset.firstDate),n=Math.floor(e/(1e3*60*60*24));t.textContent=n.toString()}});</script> </div> </div> <div class="sidebar__outer-container hidden print:hidden! grow-0 shrink max-w-70 has-sidebar:shrink-0 md:block md:relative md:has-sidebar:w-50 lg:shrink-0 lg:has-sidebar:w-70 animate-duration-300! animate-ease-in-out! xl:w-70 uno-e8c0g7"> <div class="sidebar__inner-container sticky top-0 bg-surface pt-6 md:px-0 md:h-screen max-md:show-toc:px-2 max-md:show-toc:pt-4 max-md:show-toc:border-t max-md:show-toc:border-base-300 overflow-y-auto overflow-x-visible">  <div class="hidden has-sidebar:block min-[55rem]:block"> <div id="page-toc"> <ul class="timeline w-full font-sans"> <li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="引入"> <a href="#引入" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">引入</span> </a> </li><li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="effectside-effect"> <a href="#effectside-effect" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">Effect，Side Effect</span> </a> </li><li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="algebraic-effect"> <a href="#algebraic-effect" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">Algebraic Effect</span> </a> </li> </ul> </div> <script type="module">function c(i,l){let t=null,e=!1;function o(...s){e?t=s:(i.apply(this,s),e=!0,setTimeout(()=>{e=!1,t&&(o.apply(this,t),t=null)},l))}return o}function n(i){const l=document.getElementById("page-toc");if(!l)return;const t=l.querySelectorAll("li");if(t.forEach(e=>e.classList.remove("active","active-now")),i!=null)for(const e of t){if(e.dataset.slug===i){e.classList.add("active-now");break}e.classList.add("active")}}const r=c(()=>{const i=document.querySelector(".markdown-body.is-detailed");if(!i)return;const l=Array.from(i.querySelectorAll("h1,h2,h3,h4,h5,h6").values()),t=l.findIndex(e=>e.getBoundingClientRect().y>110);t===0?n(null):t==-1?n(l.at(-1)?.id):n(l.at(t-1)?.id)},200);document.addEventListener("scroll",r);</script> </div> </div> </div>  </div> <div class="float-buttons fixed bottom-4 right-4 flex flex-col gap-2 print:hidden! text-base-content" aria-hidden="true"> <div class="opacity-0 translate-x-20 transition [body.is-scrolled_&]:opacity-100 [body.is-scrolled_&]:translate-x-0"> <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Scroll to top"> <div class="i-mingcute:arrow-up-line"></div> </button> </div> <div class="hidden has-sidebar:block md:hidden!"> <button onclick="document.body.classList.add('show-toc')" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Show TOC"> <div class="i-mingcute:list-check-fill"></div> </button> </div> </div> <script type="module">document.addEventListener("scroll",()=>{window.scrollY>100?document.body.classList.add("is-scrolled"):document.body.classList.remove("is-scrolled")});document.addEventListener("click",s=>{if(!document.body.classList.contains("show-toc"))return;let t=s.target;for(;t!=null;){if(t.classList.contains("float-buttons")||t.classList.contains("sidebar__inner-container"))return;t=t.parentElement}document.body.classList.remove("show-toc"),document.body.classList.add("removing-toc"),setTimeout(()=>{document.body.classList.remove("removing-toc")},280),s.stopPropagation()});</script> </body></html>