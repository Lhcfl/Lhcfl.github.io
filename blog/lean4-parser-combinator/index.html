<!DOCTYPE html><html lang="zh-CN"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/webp" href="/_astro/logo.zcK9pHo2_CGMl6.webp"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Zero Calorie Drink Shop" href="https://lhcfl.github.io/rss.xml"><meta name="generator" content="Astro v5.18.0"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev"><link rel="preconnect" href="https://ik.imagekit.io" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://lhcfl.github.io/blog/lean4-parser-combinator/"><!-- Primary Meta Tags --><title>学习在 Lean4 中使用 Parser Combinator ⬝ Zero Calorie Drink Shop</title><meta name="title" content="学习在 Lean4 中使用 Parser Combinator ⬝ Zero Calorie Drink Shop"><meta name="description" content="此时对于我那幽默的《编译原理》课程还在用 C 语言写编译器的不满达到了顶峰。

你说得对，但是《编译原理》是由 Alfred V. Aho, Monica S. Lam, Ravi Sethi 和 Jeffrey D. Ullman 等人自主研发的一款全旧计算机世界编程游戏。游戏发生在一个被称作「C—」的简化语言，在这里，选择这门课的人将被迫享受「GCC 7.5.0」，没有一点 5202 年该有的体验。玩家将扮演一位名为「C 程序员」的神秘角色，在自由的编码中邂逅各种各样、时机诡异的 Segment Fault 们，和他们一起泄露内存，感受 C 语言的恶心之处——同时，逐步发掘「都 5202 年了这帮人还在拿 39 年前的书教文法分析」的真相。

但跑远了。总而言之这里介绍一种叫 parser combinator —— 解析器组合子的函数式手段，为您带来哪怕是手写递归下降也很舒适的体验（并非）
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://lhcfl.github.io/blog/lean4-parser-combinator/"><meta property="og:title" content="学习在 Lean4 中使用 Parser Combinator ⬝ Zero Calorie Drink Shop"><meta property="og:description" content="此时对于我那幽默的《编译原理》课程还在用 C 语言写编译器的不满达到了顶峰。

你说得对，但是《编译原理》是由 Alfred V. Aho, Monica S. Lam, Ravi Sethi 和 Jeffrey D. Ullman 等人自主研发的一款全旧计算机世界编程游戏。游戏发生在一个被称作「C—」的简化语言，在这里，选择这门课的人将被迫享受「GCC 7.5.0」，没有一点 5202 年该有的体验。玩家将扮演一位名为「C 程序员」的神秘角色，在自由的编码中邂逅各种各样、时机诡异的 Segment Fault 们，和他们一起泄露内存，感受 C 语言的恶心之处——同时，逐步发掘「都 5202 年了这帮人还在拿 39 年前的书教文法分析」的真相。

但跑远了。总而言之这里介绍一种叫 parser combinator —— 解析器组合子的函数式手段，为您带来哪怕是手写递归下降也很舒适的体验（并非）
"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lhcfl.github.io/blog/lean4-parser-combinator/"><meta property="twitter:title" content="学习在 Lean4 中使用 Parser Combinator ⬝ Zero Calorie Drink Shop"><meta property="twitter:description" content="此时对于我那幽默的《编译原理》课程还在用 C 语言写编译器的不满达到了顶峰。

你说得对，但是《编译原理》是由 Alfred V. Aho, Monica S. Lam, Ravi Sethi 和 Jeffrey D. Ullman 等人自主研发的一款全旧计算机世界编程游戏。游戏发生在一个被称作「C—」的简化语言，在这里，选择这门课的人将被迫享受「GCC 7.5.0」，没有一点 5202 年该有的体验。玩家将扮演一位名为「C 程序员」的神秘角色，在自由的编码中邂逅各种各样、时机诡异的 Segment Fault 们，和他们一起泄露内存，感受 C 语言的恶心之处——同时，逐步发掘「都 5202 年了这帮人还在拿 39 年前的书教文法分析」的真相。

但跑远了。总而言之这里介绍一种叫 parser combinator —— 解析器组合子的函数式手段，为您带来哪怕是手写递归下降也很舒适的体验（并非）
"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.Bk5rygI5.js"></script><link rel="stylesheet" href="/_astro/_static_page_.D_hEsS3a.css">
<link rel="stylesheet" href="/_astro/_static_page_.CVCZMPgC.css">
<link rel="stylesheet" href="/_astro/_static_page_.DUMM9sSp.css"><script type="module" src="/_astro/page.B5CPI74E.js"></script></head> <body class="overflow-y-scroll has-sidebar"> <div class="app bg-surface text-content md:flex lg:justify-center max-w-full">  <header class="flex-[0_0_auto] print:hidden flex sticky top-0 font-sans max-md:items-center max-md:justify-between max-md:w-full max-md:h-15 max-md:z-50 max-md:bg-surface max-md:px-2 max-lg:w-20 md:flex-col md:h-screen md:text-lg md:p-4 md:shrink-0 md:grow-0 max-md:border-b md:border-r border-base-300"> <a href="/" class="flex flex-col items-center gap-2 lg:mt-4"> <div class="nav-site-avatar avatar w-10 md:w-12 lg:hidden"> <img src="/_astro/logo.zcK9pHo2_CGMl6.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="100" height="100"> </div> <div class="nav-site-avatar avatar max-lg:hidden w-40"> <img src="/_astro/logo.zcK9pHo2_ZuqEup.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="512" height="512"> </div> <span class="nav-site-title text-lg font-bold max-lg:hidden">Zero Calorie Drink Shop</span> </a> <nav class="links flex items-center gap-2 text-lg md:flex-col md:pt-6 md:text-2xl lg:text-base"> <a href="/" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Home" data-path-name="blog/lean4-parser-combinator/" data-href-base="/"> <svg width="1em" height="1em" data-icon="mingcute:home-3-line">   <symbol id="ai:mingcute:home-3-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.772 2.688a2 2 0 0 1 2.317-.099l.139.1l8.384 6.52c.721.561.37 1.692-.499 1.785l-.116.006H20v8a2 2 0 0 1-1.85 1.995L18 21H6a2 2 0 0 1-1.994-1.85L4 19v-8h-.997C2.09 11 1.671 9.892 2.3 9.285l.088-.076zM12 4.267L5.625 9.225c.229.185.375.468.375.785V19h3v-5a3 3 0 1 1 6 0v5h3v-8.99c0-.317.146-.6.375-.785zM12 13a1 1 0 0 0-1 1v5h2v-5a1 1 0 0 0-1-1"/></g></symbol><use href="#ai:mingcute:home-3-line"></use>  </svg> <span class="max-lg:hidden"> Home </span> </a><a href="/archives" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Archives" data-path-name="blog/lean4-parser-combinator/" data-href-base="archives"> <svg width="1em" height="1em" data-icon="mingcute:archive-line">   <symbol id="ai:mingcute:archive-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16.586 3A2 2 0 0 1 18 3.586L20.414 6A2 2 0 0 1 21 7.414V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7.414A2 2 0 0 1 3.586 6L6 3.586A2 2 0 0 1 7.414 3zM19 9H5v10h14zm-7 1a1 1 0 0 1 1 1v3.186l.414-.414a1 1 0 1 1 1.414 1.414l-2.12 2.121a1 1 0 0 1-1.415 0l-2.121-2.121a1 1 0 1 1 1.414-1.414l.414.414V11a1 1 0 0 1 1-1m4.586-5H7.414l-2 2h13.172z"/></g></symbol><use href="#ai:mingcute:archive-line"></use>  </svg> <span class="max-lg:hidden"> Archives </span> </a><a href="/notes/1" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Notes" data-path-name="blog/lean4-parser-combinator/" data-href-base="notes"> <svg width="1em" height="1em" data-icon="mingcute:notebook-line">   <symbol id="ai:mingcute:notebook-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M17 2c1.598 0 3 1.3 3 3v13c0 1.7-1.4 3-3 3H6c-1.054 0-2-.95-2-2V4c0-1.054.95-2 2-2zm0 2h-7v15h7c.513 0 1-.39 1-1V5c0-.513-.49-1-1-1M8 4H6v15h2z"/></g></symbol><use href="#ai:mingcute:notebook-line"></use>  </svg> <span class="max-lg:hidden"> Notes </span> </a><a href="/tags" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Tags" data-path-name="blog/lean4-parser-combinator/" data-href-base="tags"> <svg width="1em" height="1em" data-icon="mingcute:tag-2-line">   <symbol id="ai:mingcute:tag-2-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.238 4.827a3 3 0 0 1 2.122.878l6.485 6.486a3 3 0 0 1 0 4.242l-4.243 4.243a3 3 0 0 1-4.242 0l-6.486-6.485a3 3 0 0 1-.878-2.122V7.327a2.5 2.5 0 0 1 2.5-2.5zm0 2H5.496a.5.5 0 0 0-.5.5v4.742a1 1 0 0 0 .292.707l6.486 6.486a1 1 0 0 0 1.414 0l4.243-4.243a1 1 0 0 0 0-1.414L10.945 7.12a1 1 0 0 0-.707-.293M7.531 9.362a1.5 1.5 0 1 1 2.121 2.122a1.5 1.5 0 0 1-2.121-2.122M11.652 2a3 3 0 0 1 2.122.878l7.192 7.193a1 1 0 0 1-1.414 1.414L12.36 4.29a1 1 0 0 0-.708-.29H7a1 1 0 0 1 0-2z"/></g></symbol><use href="#ai:mingcute:tag-2-line"></use>  </svg> <span class="max-lg:hidden"> Tags </span> </a><a href="/about" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="About" data-path-name="blog/lean4-parser-combinator/" data-href-base="about"> <svg width="1em" height="1em" data-icon="mingcute:user-3-line">   <symbol id="ai:mingcute:user-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M12 13c2.396 0 4.575.694 6.178 1.672c.8.488 1.484 1.064 1.978 1.69c.486.615.844 1.351.844 2.138c0 .845-.411 1.511-1.003 1.986c-.56.45-1.299.748-2.084.956c-1.578.417-3.684.558-5.913.558s-4.335-.14-5.913-.558c-.785-.208-1.524-.506-2.084-.956C3.41 20.01 3 19.345 3 18.5c0-.787.358-1.523.844-2.139c.494-.625 1.177-1.2 1.978-1.69C7.425 13.695 9.605 13 12 13m0 2c-2.023 0-3.843.59-5.136 1.379c-.647.394-1.135.822-1.45 1.222c-.324.41-.414.72-.414.899c0 .122.037.251.255.426c.249.2.682.407 1.344.582C7.917 19.858 9.811 20 12 20c2.19 0 4.083-.143 5.4-.492c.663-.175 1.096-.382 1.345-.582c.218-.175.255-.304.255-.426c0-.18-.09-.489-.413-.899c-.316-.4-.804-.828-1.451-1.222C15.843 15.589 14.023 15 12 15m0-13a5 5 0 1 1 0 10a5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6"/></g></symbol><use href="#ai:mingcute:user-3-line"></use>  </svg> <span class="max-lg:hidden"> About </span> </a><a href="/links" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Friends" data-path-name="blog/lean4-parser-combinator/" data-href-base="links"> <svg width="1em" height="1em" data-icon="mingcute:link-3-line">   <symbol id="ai:mingcute:link-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M1 10a5 5 0 0 1 5-5h6a5 5 0 0 1 0 10a1 1 0 1 1 0-2a3 3 0 1 0 0-6H6a3 3 0 0 0-.75 5.906a1 1 0 0 1-.5 1.936A5 5 0 0 1 1 10m11 1a3 3 0 1 0 0 6h6a3 3 0 0 0 .75-5.905a1 1 0 0 1 .5-1.937A5.002 5.002 0 0 1 18 19h-6a5 5 0 0 1 0-10a1 1 0 1 1 0 2"/></g></symbol><use href="#ai:mingcute:link-3-line"></use>  </svg> <span class="max-lg:hidden"> Friends </span> </a><a href="/search" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Search" data-path-name="blog/lean4-parser-combinator/" data-href-base="search"> <svg width="1em" height="1em" data-icon="mingcute:search-3-line">   <symbol id="ai:mingcute:search-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.5 4a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13M2 10.5a8.5 8.5 0 1 1 15.176 5.262l3.652 3.652a1 1 0 0 1-1.414 1.414l-3.652-3.652A8.5 8.5 0 0 1 2 10.5M9.5 7a1 1 0 0 1 1-1a4.5 4.5 0 0 1 4.5 4.5a1 1 0 1 1-2 0A2.5 2.5 0 0 0 10.5 8a1 1 0 0 1-1-1"/></g></symbol><use href="#ai:mingcute:search-3-line"></use>  </svg> <span class="max-lg:hidden"> Search </span> </a> </nav> <div class="navbar-end md:flex-grow md:flex md:items-baseline-last md:justify-center"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="18tXJb" component-url="/_astro/DarkLightToggle.DYSrvQvV.js" component-export="default" renderer-url="/_astro/client.svelte.DN8iM4l6.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;DarkLightToggle&quot;,&quot;value&quot;:true}" await-children><!--[--><button class="i-mingcute:moon-stars-line" aria-label="toggle theme"></button><!--]--><!--astro:end--></astro-island> </div> </header> <div class="main-and-footer__outer-container max-w-full min-h-screen overflow-x-hidden flex flex-grow flex-shrink flex-basis-180 xl:grow-0 at-md:justify-center"> <div class="flex flex-col w-full max-w-180"> <main class="grow relative p-4 md:pt-6 undefined">  <article> <h1 class="page-title text-3xl font-bold"> <span class="inline-flex items-center gap-1">   <span>学习在 Lean4 中使用 Parser Combinator</span>  </span> </h1> <div> <div class="markdown-body is-detailed"> <p lang="zh">此时对于我那幽默的《编译原理》课程还在用 C 语言写编译器的不满达到了顶峰。</p>
<blockquote>
<p lang="zh">你说得对，但是《编译原理》是由 Alfred V. Aho, Monica S. Lam, Ravi Sethi 和 Jeffrey D. Ullman 等人自主研发的一款全旧计算机世界编程游戏。游戏发生在一个被称作「C—」的简化语言，在这里，选择这门课的人将被迫享受「GCC 7.5.0」，没有一点 5202 年该有的体验。玩家将扮演一位名为「C 程序员」的神秘角色，在自由的编码中邂逅各种各样、时机诡异的 Segment Fault 们，和他们一起泄露内存，感受 C 语言的恶心之处——同时，逐步发掘「都 5202 年了这帮人还在拿 39 年前的书教文法分析」的真相。</p>
</blockquote>
<p lang="zh">但跑远了。总而言之这里介绍一种叫 parser combinator —— 解析器组合子的函数式手段，为您带来哪怕是手写递归下降也很舒适的体验（并非）</p>
<!-- more -->
<h3 id="0-介绍">0. 介绍</h3>
<p lang="zh">Parser combinator（解析器组合子）是一种函数式编程中的技术，用于构建复杂语法分析器的工具。它的核心思想是：用小的、可组合的解析器函数构建更复杂的解析器。</p>
<p lang="zh">一个 parser combinator 就是一个函数，它接受一些解析器作为输入，返回一个新的、更复杂的解析器。它是一种“组合模式”，非常适合处理递归文法。</p>
<p lang="zh">一个经典的 Parser 可以是：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">abbrev</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α : </span><span style="color:#D73A49;--shiki-dark:#F97583">Type</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := List Char → Option </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α × List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">也就是说，一个 parser 就是是一个函数，接受 List Char 作为参数，如果解析成功，返回 <code>.some (α × List Char)</code> 为解析结果和剩余内容。如果失败，返回 <code>.none</code>.</p>
<p lang="zh">在这里，为了一步到位地解决报错，我们把返回类型改成 Except</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">abbrev</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α : </span><span style="color:#D73A49;--shiki-dark:#F97583">Type</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := List Char → Except String </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α × List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">这样，如果报错就能看到一个字符串作为错误信息。</p>
<p lang="zh">对于不熟悉函数式写法的人，这是它的类似的 Rust 代码（懒得配平生命周期了）：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">#!</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8">feature</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">type_alias_impl_trait</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Box</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">dyn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> FnOnce</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">where</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    T</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> '</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">impl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> chain</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">U</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, other</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">U</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">U</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> f </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> self</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> g </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> other</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">move</span><span style="color:#D73A49;--shiki-dark:#F97583"> |</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">t, input</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> f</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">u, input</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> g</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            Ok</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">t, u</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">impl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">F</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">From</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">F</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">for</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">where</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    F</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> FnOnce</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> '</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> from</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">value</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> F</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Self</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        Parser</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Box</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">new</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">c</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">move</span><span style="color:#D73A49;--shiki-dark:#F97583"> |</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> str</span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_empty</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Err</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Input is empty"</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">to_string</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">chars</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">unwrap</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> c </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            Ok</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">c, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8">c</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">len_utf8</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">..</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            Err</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">format!</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Expected '{}', found '{}'"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, c, input</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">chars</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">unwrap</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">into</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> res </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'a'</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"anc"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    println!</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Result: {:?}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> res </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'a'</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">chain</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'b'</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"anc"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    println!</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Result: {:?}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> res </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'a'</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">chain</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'b'</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"abc"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    println!</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Result: {:?}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // Result: Ok(('a', "nc"))</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // Result: Err("Expected 'b', found 'n'")</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // Result: Ok((('a', 'b'), "c"))</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="it">其中，<code>chain</code> 就是一个 combinator，它用两个小的 parser 合成了一个大的 parser。</p>
<h3 id="1-抽象">1. 抽象</h3>
<p lang="zh">让我们再次请出万能的 Monad 来。关于 Monad 是什么，不妨看看<a href="https://lhcfl.github.io/blog/learn-monads/">所以这个 Monads 到底是什么啊之让我学学</a></p>
<p lang="zh">一个 parser 的合成过程经常需要前面的 parse 都 ok，一旦其中某一个不是 ok 的了，就短路返回 error。这是典型的 monad 行为</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">instance</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Monad Parser </span><span style="color:#D73A49;--shiki-dark:#F97583">where</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  pure := </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  bind := </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parser f =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ← parser input</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      f a rest</span></span></code></pre>
<p lang="zh">实现了 monad 的特征以后，我们就能方便的使用 do-记号，如</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> symbol</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser $ Int :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'+'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'-'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> digits</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser $ List Char :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .ok $ input.span </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">·.isDigit</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseInt</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> symbol ← symbol</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> numStr ← digits</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> numStr.asString.toInt? </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | some n =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.int $ symbol * n</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | none   =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fail </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"expected an integer, but got non-digit characters"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#eval</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseInt </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"12345abced12345"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.data</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- Except.ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Json.int </span><span style="color:#005CC5;--shiki-dark:#79B8FF">12345</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#e36209;--shiki-dark:#ffab70">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'a'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'b'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'c'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'e'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'d'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'3'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'4'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'5'</span><span style="color:#e36209;--shiki-dark:#ffab70">]</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">其次，一个 parser 还能实现 <code>Alternative</code>（选择子）。字面意义上地，</p>
<blockquote>
<p lang="en">An <code>Alternative</code> functor is an <code>Applicative</code> functor that can “fail” or be “empty” and a binary operation <code>&#x3C;|></code> that “collects values” or finds the “left-most success”.</p>
<p lang="ca">Important instances include</p>
<ul lang="en">
<li><code>Option</code>, where <code>failure := none</code> and <code>&#x3C;|></code> returns the left-most <code>some</code>.</li>
<li>Parser combinators typically provide an <code>Applicative</code> instance for error-handling and backtracking.</li>
</ul>
<p lang="en">Error recovery and state can interact subtly. For example, the implementation of <code>Alternative</code> for <code>OptionT (StateT σ Id)</code> keeps modifications made to the state while recovering from failure, while <code>StateT σ (OptionT Id)</code> discards them.</p>
</blockquote>
<p lang="gl">关于函子 functor 的概念我推荐阅读<a href="https://sxyz.blog/functors-applicatives-and-monads-in-pictures/">图解 Functor、Applicative、Monad</a>。这样，我们用</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">parser1 </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parser2</span></span></code></pre>
<p lang="zh">就能描述“第一个解析成功的 parser”。</p>
<p lang="zh">或许 parser 还适用一些别的抽象，但我也是刚学，想到写什么就放些什么了（）总而言之，让我们又双叒叕开启愉快的 JSON 解析之旅。</p>
<h3 id="2-实践json-解析器">2. 实践：JSON 解析器</h3>
<p lang="zh">还是熟悉的 JSON</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">inductive</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Json</span><span style="color:#D73A49;--shiki-dark:#F97583"> where</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | null</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | bool </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: Bool</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | int  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: Int</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | float</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: Float</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | str  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | arr  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: List Json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | obj  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x: List </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">String × Json</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">deriving</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Repr</span></span></code></pre>
<p lang="zh">这次我们要正确地解析数字，所以引入了 int 和 float 类型。然后是准备工作：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">abbrev</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α : </span><span style="color:#D73A49;--shiki-dark:#F97583">Type</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := List Char → Except String </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α × List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fail</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">reason : String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser α :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error reason</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 无论如何总是返回失败原因的函数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">instance</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Monad Parser </span><span style="color:#D73A49;--shiki-dark:#F97583">where</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  pure := </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  bind := </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> p f =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ← p input</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      f a rest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">instance</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Alternative Parser </span><span style="color:#D73A49;--shiki-dark:#F97583">where</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  failure := fail </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"unknown error"</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  orElse p₁ p₂ := </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> p₁ input </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | .ok    r =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok r</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | .error _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> p₂ </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input</span></span></code></pre>
<p lang="zh">接下来可以实践写几个辅助函数</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 返回一个拿一个 char 的 parser</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">c : Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Char :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">   fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | x :: xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x == c </span><span style="color:#D73A49;--shiki-dark:#F97583">then</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">c, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error </span><span style="color:#D73A49;--shiki-dark:#F97583">s!</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Expected '</span><span style="color:#D73A49;--shiki-dark:#F97583">{</span><span style="color:#032F62;--shiki-dark:#9ECBFF">c</span><span style="color:#D73A49;--shiki-dark:#F97583">}</span><span style="color:#032F62;--shiki-dark:#9ECBFF">', got '</span><span style="color:#D73A49;--shiki-dark:#F97583">{</span><span style="color:#032F62;--shiki-dark:#9ECBFF">x</span><span style="color:#D73A49;--shiki-dark:#F97583">}</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'"</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error </span><span style="color:#D73A49;--shiki-dark:#F97583">s!</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Unexpected EOF, expected character '</span><span style="color:#D73A49;--shiki-dark:#F97583">{</span><span style="color:#032F62;--shiki-dark:#9ECBFF">c</span><span style="color:#D73A49;--shiki-dark:#F97583">}</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 返回一个拿走前面的 whitespace 的 parser</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> whitespaces</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Unit :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input.dropWhile </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">·.isWhitespace</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 返回一个拿一个 + 或者 - 符号的 parser</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> symbol</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser $ Int :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'+'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'-'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | xs =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 返回一个拿数字的 parser</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> digits</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser $ List Char :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .ok $ input.span </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">·.isDigit</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span></code></pre>
<p lang="zh">这样， number 的 parse 工作就变得很简单，只需要分两种情况：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseInt</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> symbol ← symbol</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> numStr ← digits</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> numStr.asString.toInt? </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | some n =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.int $ symbol * n</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | none   =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fail </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"expected an integer, but got non-digit characters"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> toFloat</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">num : List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fraction : List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Option Float := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> num ← num.asString.toNat?</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fra ← fraction.asString.toNat?</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> exp := </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ^ fraction.length.toFloat</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> num.toFloat + </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fra.toFloat * exp</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseFloat</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> symbol ← symbol</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> num ← digits</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'.'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fraction ← digits</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> toFloat num fraction </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | .some num =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.float $ </span><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> symbol == -</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#D73A49;--shiki-dark:#F97583"> then</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -num </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> num</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | .none =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fail </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"expected a float"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseNumber</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  parseFloat </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">|</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseInt</span></span></code></pre>
<p lang="zh">现在我们的 <code>paserNumber</code> 就是一个既可以解析整数又可以解析浮点数的 parser 了！</p>
<p lang="zh">随后我们一鼓作气，把几个简单的 parser 写掉。先写字符串：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>def quotedString : Parser $ List Char := do</span></span>
<span class="line"><span>  _ ← char '"'</span></span>
<span class="line"><span>  fun input =></span></span>
<span class="line"><span>    let (str, last) := input.span (· != '"')</span></span>
<span class="line"><span>    .ok (str, last.drop 1)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>def parseString : Parser Json := do</span></span>
<span class="line"><span>  let str ← quotedString</span></span>
<span class="line"><span>   return (Json.str str.asString)</span></span></code></pre>
<p lang="zh">为什么要分 quoted string 和 string 呢？因为后者直接得到了一个 <code>Json</code>，但我们还要在 object 那里复用获得字符串的 parser。</p>
<p lang="zh">随后是几个关键字，异常简单：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> keyword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">kw : String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val : Json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input.asString.startsWith kw </span><span style="color:#D73A49;--shiki-dark:#F97583">then</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val, input.drop kw.length</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error </span><span style="color:#D73A49;--shiki-dark:#F97583">s!</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Expected keyword '</span><span style="color:#D73A49;--shiki-dark:#F97583">{</span><span style="color:#032F62;--shiki-dark:#9ECBFF">kw</span><span style="color:#D73A49;--shiki-dark:#F97583">}</span><span style="color:#032F62;--shiki-dark:#9ECBFF">', but got '</span><span style="color:#D73A49;--shiki-dark:#F97583">{</span><span style="color:#032F62;--shiki-dark:#9ECBFF">input.asString</span><span style="color:#D73A49;--shiki-dark:#F97583">}</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseTrue</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := keyword </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"true"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ Json.bool </span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseFalse</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := keyword </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"false"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ Json.bool </span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseNull</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := keyword </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"null"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.null</span></span></code></pre>
<p lang="zh">现在是三个递归结构：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-- 这是一个辅助函数，用来把以 sep 分割的 a 生成一个 list parser</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> sepBy</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">α : Parser a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sep : Parser b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">List a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#D73A49;--shiki-dark:#F97583"> rec</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> go </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc : List a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input : List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">List a × List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> α input </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> sep rest </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        | .ok </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">_, rest'</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> go </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc.concat a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> rest'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        | .error _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc.concat a, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | .error _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .ok $ go </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">mutual</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseArray</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'['</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> elems ← sepBy parseJson </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">','</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">']'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.arr elems</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseObject</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'{'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> pairs ← sepBy parsePair </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">','</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'}'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.obj pairs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parsePair</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">String × Json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> key ← quotedString</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← whitespaces</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">':'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value ← parseJson</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key.asString, value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseJson</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> json ← </span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'n'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseNull str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'t'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseTrue str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'f'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseFalse str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'['</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseArray str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'{'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseObject str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'"'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseString str</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | _ =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseNumber str</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> json</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">end</span></span></code></pre>
<p lang="zh">整个逻辑极其清晰和简单！这就是 parser combinator 的魅力。回顾我们之前写的 lean4 的 json 大概长这样</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseJsonObject</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fuel: Nat</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">str: List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Except String </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">List </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">String × Json</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> × List Char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fuel </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"out of fuel"</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  | .succ fuel =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xs := trimList str</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ret : List </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">String × Json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  while</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#D73A49;--shiki-dark:#F97583"> do</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xs </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'"'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: next =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key, next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ← parseJsonString next</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      xs := trimList next</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xs.head? != some </span><span style="color:#032F62;--shiki-dark:#9ECBFF">':'</span><span style="color:#D73A49;--shiki-dark:#F97583"> then</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        .error </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"expect `:` but got unexpected token"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      else</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        xs := xs.tail</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val, next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ← parseJsonValue fuel xs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      ret := ret.append </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key, val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      match</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> trimList next </span><span style="color:#D73A49;--shiki-dark:#F97583">with</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">','</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: next =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xs := trimList next</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'}'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: next =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ret, next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      | x =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error $ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"expect `,` or `}` but got unexpected token:"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ++ String.mk x</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'}'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> :: next =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ret, next</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    | x =</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .error $ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"unexpected token:"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ++ String.mk x</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#e36209;--shiki-dark:#ffab70">[</span><span style="color:#e36209;--shiki-dark:#ffab70">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, xs.tail</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">termination_by</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fuel</span></span></code></pre>
<p lang="pt">虽然比起抽象更少的 gleam 还是很不错，但对比 parser combinator 的做法：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parseObject</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser Json := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'{'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> pairs ← sepBy parsePair </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">','</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← whitespaces</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'}'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Json.obj pairs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">partial</span><span style="color:#D73A49;--shiki-dark:#F97583"> def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parsePair</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : Parser </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">String × Json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> key ← quotedString</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← whitespaces</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  _ ← char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">':'</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value ← parseJson</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key.asString, value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<p lang="zh">显然，所有人都看得出来， parser combinator 的做法非常简洁明了，可读性极强。</p>
<p lang="zh">如果你正在编写一个传统的递归下降解析器来解析 JSON 数组，你可能会尝试在循环中解析语句，当它无法解析中间的逗号时停止。这个过程很难做到复用，除非你其实已经在写一个 parser combinator 了。比如我之前写的 C++ 的解析器：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Node</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ObjectVT</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">unordered_map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">JSON</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  ObjectVT value_</span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Object</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  explicit</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ObjectVT</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">value_</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Object</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Object</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> delete</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 删掉拷贝构造函数</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Object</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> delete</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  inline</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">unique_ptr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string_view</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">sv</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> dep</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    assert_depth</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, dep</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    removeWhiteSpaces</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">!=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '{'</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      throw</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getJSONParseError</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"object start `{`"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    sv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove_prefix</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    removeWhiteSpaces</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    ObjectVT val;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> isTComma </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 是不是尾随逗号</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    while</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">!=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '}'</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      auto</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> key </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 解析 key</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ENABLE_DUMPLICATED_KEY_DETECT </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> val.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">contains</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        throw</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getJSONParseError</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            sv, </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"unique key, but got dumplicated key `"</span><span style="color:#D73A49;--shiki-dark:#F97583"> +</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> key-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "`"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">c_str</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        removeWhiteSpaces</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#5a32a3;--shiki-dark:#b392f0">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#5a32a3;--shiki-dark:#b392f0">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">!=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ':'</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 解析 key :</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          throw</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getJSONParseError</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"object spliter `:`"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        sv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove_prefix</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        val.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8">key-</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#6F42C1;--shiki-dark:#B392F0">take</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">JSON</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, dep </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        removeWhiteSpaces</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 解析 key : value</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        switch</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv</span><span style="color:#5a32a3;--shiki-dark:#b392f0">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#5a32a3;--shiki-dark:#b392f0">]</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        case</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '}'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // 看看结束了没</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          sv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove_prefix</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">make_unique</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        case</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ','</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          sv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove_prefix</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          isTComma </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          continue</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">          throw</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getJSONParseError</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"object spliter `,` or object end `}`"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">isTComma </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#D73A49;--shiki-dark:#F97583"> !</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ENABLE_TRAILING_COMMA</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      throw</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> getJSONParseError</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">sv, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"next json value"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    sv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">remove_prefix</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">make_unique</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // ...</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">但如你所见，使用函数式语言 parser combinator 的话，定义一个复用的解析器极其简单</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="lean"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> arrayElems</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := sepBy parseJson </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">','</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> urlParams</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> := sepBy </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">agg3 $ parseVar </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'='</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> parseVal</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">char </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'&#x26;'</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span></code></pre>
<h3 id="3-扩展用在不那么方便的语言上">3. 扩展：用在不那么方便的语言上？</h3>
<p lang="zh">显然这一套是很容易用在不那么方便的语言上的。对比<a href="/2025/01/06/gleam-intro/#%E5%AE%9E%E6%88%98%EF%BC%9A%E5%86%99%E4%B8%AA-JSON-Parser">刚接触函数式的时候写出来的幽默代码</a>，这套使用了解析器组合子的代码要好看很多，好理解很多</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="gleam"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> gleam</span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">dict</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> gleam</span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">io</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> gleam</span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">list</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> gleam</span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">result</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> gleam</span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">string</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> type</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Node</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Nul</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Bol</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Bool</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Num</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Int</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Str</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Arr</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  Obj</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#24292E;--shiki-dark:#E1E4E8">dict.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Dict</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">type</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">t</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">t, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// Parser 工具</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">builder: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">f: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">builder</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result_is</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">builder: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">f: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">builder</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> or</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">p1: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">p2: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> p1</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> p2</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">p: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">f: </span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">p</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">f</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> chain</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">p1: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">p2: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a, b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res1, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">p1</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res2, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">p2</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">res1, res2</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> go_for_seq_by</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  p: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  sep: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  acc: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> p</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> sep</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">rest</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> go_for_seq_by</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">p, sep, acc </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> list.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">]</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> list.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">]</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Error</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">acc, input</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> seq_by</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">p: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">sep: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">a</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">go_for_seq_by</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">p, sep, </span><span style="color:#e36209;--shiki-dark:#ffab70">[</span><span style="color:#e36209;--shiki-dark:#ffab70">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// JSON 工具函数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">c: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">str: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    case</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.pop_grapheme </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Nil</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Unexpected EOF"</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">first, rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> first </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> c </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">first, rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"need char '"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> c </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "', got unexpected token "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> whitespace</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, input </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.trim_start</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ident</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">id: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">str: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    case</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">starts_with</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      True</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id, str </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">drop_start</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">string.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">length</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">id</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      False</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"need "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> id </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ", got unexpected token "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> str</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> true_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  ident</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"true"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Bol</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">True</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> false_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  ident</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"false"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Bol</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">False</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> null_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  ident</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"null"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Nul</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> string_key_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    use</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, rest</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">then</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    case</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> rest </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">split_once</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val, rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Ok</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val, rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6A737D;--shiki-dark:#6A737D">_</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"except string key, got unexpected token "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> string_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  string_key_parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Str</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">val: </span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> array_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  char</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"["</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result_is</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    json_parser</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> seq_by</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">","</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arr</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whitespace</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"]"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> pair_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  whitespace</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result_is</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string_key_parser</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whitespace</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">":"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> chain</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">json_parser</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> object_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  char</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"{"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whitespace</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result_is</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    pair_parser</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> seq_by</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">","</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> map</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Obj</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">dict.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">from_list</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whitespace</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">char</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"}"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> json_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fn</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.trim_start</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    case</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> input </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "t"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> true_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "f"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> false_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "n"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> null_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> string_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "["</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> array_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">      "{"</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> object_parser</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      x </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"unexpected token "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // eat whitespaces</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  |</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> skip</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">whitespace</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> parse_json</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">input: </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Node</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">String</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> json_parser</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input </span><span style="color:#D73A49;--shiki-dark:#F97583">|</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string.trim_start</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Ok</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">node, rest</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      case</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> rest </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#032F62;--shiki-dark:#9ECBFF">        ""</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Ok</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">node</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        _</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"unexpected token "</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> rest</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Error</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">err</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Error</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">err</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"null"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"true"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"false"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">wwww</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"{}"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">a</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: true, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">b</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: [true, false, null]}"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">a</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">  : true, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">b</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">  : [true, false, null]}"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"[ true, false, null, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">abcd</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ]"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  let</span><span style="color:#6A737D;--shiki-dark:#6A737D"> _</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parse_json</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"[true,false,null,</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">abcd</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">  ]"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  io.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">debug</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"done"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre> </div>
    <div class="divider"></div>
    <p class="post-meta flex flex-wrap items-center gap-2 text-base-content/60"> <span class="date flex gap-1 items-center shrink-0 text-sm"> <svg width="1em" height="1em" data-icon="mingcute:calendar-2-line">   <symbol id="ai:mingcute:calendar-2-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16 3a1 1 0 0 1 1 1v1h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2V4a1 1 0 0 1 2 0v1h6V4a1 1 0 0 1 1-1M8 7H5v2h14V7h-3zm-3 4v8h14v-8zm2 2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H16a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z"/></g></symbol><use href="#ai:mingcute:calendar-2-line"></use>  </svg> <time datetime="2025-04-13T01:19:40.000Z"> 2025/04/13 </time> </span> <span class="flex flex-wrap max-w-full overflow-hidden text-ellipsis gap-2"> <a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Code/"> <svg width="1em" height="1em" class="shrink-0" data-icon="mingcute:tag-line">   <symbol id="ai:mingcute:tag-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.537 2.164a3 3 0 0 1 2.244.727l.15.14l7.822 7.823a3 3 0 0 1 .135 4.098l-.135.144l-5.657 5.657a3 3 0 0 1-4.098.135l-.144-.135L3.03 12.93a3 3 0 0 1-.878-2.188l.011-.205l.472-5.185a3 3 0 0 1 2.537-2.695l.179-.021zm.308 1.989l-.127.003l-5.185.472a1 1 0 0 0-.888.787l-.017.118l-.472 5.185a1 1 0 0 0 .206.703l.083.095l7.823 7.823a1 1 0 0 0 1.32.083l.094-.083l5.657-5.657a1 1 0 0 0 .083-1.32l-.083-.094l-7.823-7.823a1 1 0 0 0-.671-.292M7.317 7.318a3 3 0 1 1 4.243 4.243a3 3 0 0 1-4.243-4.243m2.829 1.414a1 1 0 1 0-1.415 1.414a1 1 0 0 0 1.415-1.414"/></g></symbol><use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Code</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Lean/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Lean</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Functional/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Functional</span> </a> </span> </p>
    <div class="mt-8 border-t border-t-base-300 pt-4"><div class="comments-container"> <div id="gitalk-mainEl" data-uid="blog:lean4-parser-combinator"></div> </div> <script type="module" src="/_astro/GitalkComment.astro_astro_type_script_index_0_lang.C8Q7p-gl.js"></script> </div> </div> </article>  </main> <footer> <div class="text-center mb-4 markdown-body font-sans text-xs!"> <p>
&copy; 2026 Linca. All rights reserved.
</p> <p>
开业 <span id="BLOG_DAYS" data-first-date="1538918349000">2700</span> 天里，写下了 56 篇博客，2 篇页面，9 篇杂记，357221 字符。
</p> <p>
Powered by
<a href="https://astro.build" target="_blank" rel="noopener noreferrer">
Astro
</a>
and
<a href="https://github.com/Lhcfl/astro-theme-krypton2" target="_blank" rel="noopener noreferrer">
Krypton 2
</a>.
</p> </div> </footer> <script type="module">document.addEventListener("astro:page-load",()=>{const t=document.getElementById("BLOG_DAYS");if(t){const e=Date.now()-Number(t.dataset.firstDate),n=Math.floor(e/(1e3*60*60*24));t.textContent=n.toString()}});</script> </div> </div> <div class="sidebar__outer-container hidden print:hidden! grow-0 shrink max-w-70 has-sidebar:shrink-0 md:block md:relative md:has-sidebar:w-50 lg:shrink-0 lg:has-sidebar:w-70 animate-duration-300! animate-ease-in-out! xl:w-70 uno-e8c0g7"> <div class="sidebar__inner-container sticky top-0 bg-surface pt-6 md:px-0 md:h-screen max-md:show-toc:px-2 max-md:show-toc:pt-4 max-md:show-toc:border-t max-md:show-toc:border-base-300 overflow-y-auto overflow-x-visible">  <div class="hidden has-sidebar:block min-[55rem]:block"> <div id="page-toc"> <ul class="timeline w-full font-sans"> <li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="0-介绍"> <a href="#0-介绍" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">0. 介绍</span> </a> </li><li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="1-抽象"> <a href="#1-抽象" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">1. 抽象</span> </a> </li><li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="2-实践json-解析器"> <a href="#2-实践json-解析器" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">2. 实践：JSON 解析器</span> </a> </li><li class="toc-item group flex items-center gap-2 transition text-base-content/60 [&#38;.active]:text-secondary [&#38;.active-now]:text-secondary+30 px-2 py-1 hover:bg-secondary/10 hover:text-secondary" data-slug="3-扩展用在不那么方便的语言上"> <a href="#3-扩展用在不那么方便的语言上" class="flex items-center gap-1 w-full"> <div class="shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">3. 扩展：用在不那么方便的语言上？</span> </a> </li> </ul> </div> <script type="module">function c(i,l){let t=null,e=!1;function o(...s){e?t=s:(i.apply(this,s),e=!0,setTimeout(()=>{e=!1,t&&(o.apply(this,t),t=null)},l))}return o}function n(i){const l=document.getElementById("page-toc");if(!l)return;const t=l.querySelectorAll("li");if(t.forEach(e=>e.classList.remove("active","active-now")),i!=null)for(const e of t){if(e.dataset.slug===i){e.classList.add("active-now");break}e.classList.add("active")}}const r=c(()=>{const i=document.querySelector(".markdown-body.is-detailed");if(!i)return;const l=Array.from(i.querySelectorAll("h1,h2,h3,h4,h5,h6").values()),t=l.findIndex(e=>e.getBoundingClientRect().y>110);t===0?n(null):t==-1?n(l.at(-1)?.id):n(l.at(t-1)?.id)},200);document.addEventListener("scroll",r);</script> </div> </div> </div>  </div> <div class="float-buttons fixed bottom-4 right-4 flex flex-col gap-2 print:hidden! text-base-content" aria-hidden="true"> <div class="opacity-0 translate-x-20 transition [body.is-scrolled_&]:opacity-100 [body.is-scrolled_&]:translate-x-0"> <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Scroll to top"> <div class="i-mingcute:arrow-up-line"></div> </button> </div> <div class="hidden has-sidebar:block md:hidden!"> <button onclick="document.body.classList.add('show-toc')" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Show TOC"> <div class="i-mingcute:list-check-fill"></div> </button> </div> </div> <script type="module">document.addEventListener("scroll",()=>{window.scrollY>100?document.body.classList.add("is-scrolled"):document.body.classList.remove("is-scrolled")});document.addEventListener("click",s=>{if(!document.body.classList.contains("show-toc"))return;let t=s.target;for(;t!=null;){if(t.classList.contains("float-buttons")||t.classList.contains("sidebar__inner-container"))return;t=t.parentElement}document.body.classList.remove("show-toc"),document.body.classList.add("removing-toc"),setTimeout(()=>{document.body.classList.remove("removing-toc")},280),s.stopPropagation()});</script> </body></html>