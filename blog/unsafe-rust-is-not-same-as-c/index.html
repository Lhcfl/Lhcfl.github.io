<!DOCTYPE html><html lang="zh-CN"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/webp" href="/_astro/logo.zcK9pHo2_2eS7vq.webp"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Zero Calorie Drink Shop" href="https://lhcfl.github.io/rss.xml"><meta name="generator" content="Astro v5.10.0"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev"><link rel="preconnect" href="https://ik.imagekit.io" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://lhcfl.github.io/blog/unsafe-rust-is-not-same-as-c/"><!-- Primary Meta Tags --><title>Unsafe Rust 并不和 C 语言一样：从 Aliasing 谈起 ⬝ Zero Calorie Drink Shop</title><meta name="title" content="Unsafe Rust 并不和 C 语言一样：从 Aliasing 谈起 ⬝ Zero Calorie Drink Shop"><meta name="description" content="在社区中你可能听到一种说法：在 unsafe 块里你可以像 C1 语言那样写。然而事实并不是这样，C 语言的约束太差，事实上给了程序员太多“宽松”的东西。而在 Rust 里，unsafe 真的很 unsafe —— 当你要接管编译器为你做的安全保证，危险就暗藏在其中。
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://lhcfl.github.io/blog/unsafe-rust-is-not-same-as-c/"><meta property="og:title" content="Unsafe Rust 并不和 C 语言一样：从 Aliasing 谈起 ⬝ Zero Calorie Drink Shop"><meta property="og:description" content="在社区中你可能听到一种说法：在 unsafe 块里你可以像 C1 语言那样写。然而事实并不是这样，C 语言的约束太差，事实上给了程序员太多“宽松”的东西。而在 Rust 里，unsafe 真的很 unsafe —— 当你要接管编译器为你做的安全保证，危险就暗藏在其中。
"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lhcfl.github.io/blog/unsafe-rust-is-not-same-as-c/"><meta property="twitter:title" content="Unsafe Rust 并不和 C 语言一样：从 Aliasing 谈起 ⬝ Zero Calorie Drink Shop"><meta property="twitter:description" content="在社区中你可能听到一种说法：在 unsafe 块里你可以像 C1 语言那样写。然而事实并不是这样，C 语言的约束太差，事实上给了程序员太多“宽松”的东西。而在 Rust 里，unsafe 真的很 unsafe —— 当你要接管编译器为你做的安全保证，危险就暗藏在其中。
"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.AM2StPgK.js"></script><link rel="stylesheet" href="/_astro/_static_page_.DYt1UbNe.css">
<link rel="stylesheet" href="/_astro/_static_page_.DST4ihUU.css">
<link rel="stylesheet" href="/_astro/_static_page_.CGWgwbcx.css">
<style>@reference "../styles/tailwind.css";.items[data-astro-cid-qtyrxm4s]{display:flex;flex-wrap:wrap;gap:calc(var(--spacing) * 2);max-width:100%;text-overflow:ellipsis;overflow:hidden}.item[data-astro-cid-qtyrxm4s]{font-size:var(--text-sm-fontSize);line-height:var(--un-leading, var(--text-sm-lineHeight));display:flex;gap:calc(var(--spacing) * 1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;align-items:center;position:relative}.item[data-astro-cid-qtyrxm4s]:after{background-color:color-mix(in srgb,var(--colors-primary) 50%,transparent);width:100%;height:.15em;--un-scale-x:0%;--un-scale-y:0%;scale:var(--un-scale-x) var(--un-scale-y);transition-property:all;transition-timing-function:var(--un-ease, var(--default-transition-timingFunction));transition-duration:var(--un-duration, var(--default-transition-duration));left:calc(var(--spacing) * 0);bottom:calc(var(--spacing) * 0);position:absolute;content:""}@supports (color: color-mix(in lab,red,red)){.item[data-astro-cid-qtyrxm4s]:after{background-color:color-mix(in oklab,var(--colors-primary) 50%,transparent)}}@property --un-bg-opacity{syntax:"<percentage>";inherits:false;initial-value:100%;}.item[data-astro-cid-qtyrxm4s]:hover:after{--un-scale-x:100%;--un-scale-y:100%;scale:var(--un-scale-x) var(--un-scale-y)}@property --un-scale-x{syntax:"*";inherits:false;initial-value:1;syntax:"*";inherits:false;initial-value:1;}@property --un-scale-y{syntax:"*";inherits:false;initial-value:1;syntax:"*";inherits:false;initial-value:1;}@property --un-scale-z{syntax:"*";inherits:false;initial-value:1;syntax:"*";inherits:false;initial-value:1;}
</style><script type="module" src="/_astro/page.sN3tJsal.js"></script></head> <body class="overflow-y-scroll has-sidebar"> <div class="app bg-surface text-content md:flex lg:justify-center max-w-full">  <header class="print:hidden flex sticky top-0 flex-[0_0_auto]" un-max-md="items-center justify-between w-full h-15 z-50 bg-surface px-2" un-max-lg="w-20" un-lg="w-70" un-md="flex-col h-screen text-lg p-4 flex-shrink-0 flex-grow-0" un-border="max-md:b md:r  base-300"> <a href="/" class="flex flex-col items-center gap-2 lg:mt-4"> <div class="nav-site-avatar avatar w-10 md:w-12 lg:hidden"> <img src="/_astro/logo.zcK9pHo2_2eS7vq.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="100" height="100"> </div> <div class="nav-site-avatar avatar max-lg:hidden w-40"> <img src="/_astro/logo.zcK9pHo2_16JEEU.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="512" height="512"> </div> <span class="nav-site-title text-lg font-bold max-lg:hidden">Zero Calorie Drink Shop</span> </a> <nav class="links flex items-center gap-2 text-lg" un-md="flex-col pt-6 text-2xl" un-lg="text-base"> <a href="/" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Home" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="/"> <svg width="1em" height="1em" data-icon="mingcute:home-3-line">   <symbol id="ai:mingcute:home-3-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.772 2.688a2 2 0 0 1 2.317-.099l.139.1l8.384 6.52c.721.561.37 1.692-.499 1.785l-.116.006H20v8a2 2 0 0 1-1.85 1.995L18 21H6a2 2 0 0 1-1.994-1.85L4 19v-8h-.997C2.09 11 1.671 9.892 2.3 9.285l.088-.076zM12 4.267L5.625 9.225c.229.185.375.468.375.785V19h3v-5a3 3 0 1 1 6 0v5h3v-8.99c0-.317.146-.6.375-.785zM12 13a1 1 0 0 0-1 1v5h2v-5a1 1 0 0 0-1-1"/></g></symbol><use href="#ai:mingcute:home-3-line"></use>  </svg> <span class="max-lg:hidden"> Home </span> </a><a href="/archives" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Archives" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="archives"> <svg width="1em" height="1em" data-icon="mingcute:archive-line">   <symbol id="ai:mingcute:archive-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16.586 3A2 2 0 0 1 18 3.586L20.414 6A2 2 0 0 1 21 7.414V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7.414A2 2 0 0 1 3.586 6L6 3.586A2 2 0 0 1 7.414 3zM19 9H5v10h14zm-7 1a1 1 0 0 1 1 1v3.186l.414-.414a1 1 0 1 1 1.414 1.414l-2.12 2.121a1 1 0 0 1-1.415 0l-2.121-2.121a1 1 0 1 1 1.414-1.414l.414.414V11a1 1 0 0 1 1-1m4.586-5H7.414l-2 2h13.172z"/></g></symbol><use href="#ai:mingcute:archive-line"></use>  </svg> <span class="max-lg:hidden"> Archives </span> </a><a href="/notes/1" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Notes" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="notes"> <svg width="1em" height="1em" data-icon="mingcute:notebook-line">   <symbol id="ai:mingcute:notebook-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M17 2c1.598 0 3 1.3 3 3v13c0 1.7-1.4 3-3 3H6c-1.054 0-2-.95-2-2V4c0-1.054.95-2 2-2zm0 2h-7v15h7c.513 0 1-.39 1-1V5c0-.513-.49-1-1-1M8 4H6v15h2z"/></g></symbol><use href="#ai:mingcute:notebook-line"></use>  </svg> <span class="max-lg:hidden"> Notes </span> </a><a href="/tags" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Tags" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="tags"> <svg width="1em" height="1em" data-icon="mingcute:tag-2-line">   <symbol id="ai:mingcute:tag-2-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.238 4.827a3 3 0 0 1 2.122.878l6.485 6.486a3 3 0 0 1 0 4.242l-4.243 4.243a3 3 0 0 1-4.242 0l-6.486-6.485a3 3 0 0 1-.878-2.122V7.327a2.5 2.5 0 0 1 2.5-2.5zm0 2H5.496a.5.5 0 0 0-.5.5v4.742a1 1 0 0 0 .292.707l6.486 6.486a1 1 0 0 0 1.414 0l4.243-4.243a1 1 0 0 0 0-1.414L10.945 7.12a1 1 0 0 0-.707-.293M7.531 9.362a1.5 1.5 0 1 1 2.121 2.122a1.5 1.5 0 0 1-2.121-2.122M11.652 2a3 3 0 0 1 2.122.878l7.192 7.193a1 1 0 0 1-1.414 1.414L12.36 4.29a1 1 0 0 0-.708-.29H7a1 1 0 0 1 0-2z"/></g></symbol><use href="#ai:mingcute:tag-2-line"></use>  </svg> <span class="max-lg:hidden"> Tags </span> </a><a href="/about" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="About" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="about"> <svg width="1em" height="1em" data-icon="mingcute:user-3-line">   <symbol id="ai:mingcute:user-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M12 13c2.396 0 4.575.694 6.178 1.672c.8.488 1.484 1.064 1.978 1.69c.486.615.844 1.351.844 2.138c0 .845-.411 1.511-1.003 1.986c-.56.45-1.299.748-2.084.956c-1.578.417-3.684.558-5.913.558s-4.335-.14-5.913-.558c-.785-.208-1.524-.506-2.084-.956C3.41 20.01 3 19.345 3 18.5c0-.787.358-1.523.844-2.139c.494-.625 1.177-1.2 1.978-1.69C7.425 13.695 9.605 13 12 13m0 2c-2.023 0-3.843.59-5.136 1.379c-.647.394-1.135.822-1.45 1.222c-.324.41-.414.72-.414.899c0 .122.037.251.255.426c.249.2.682.407 1.344.582C7.917 19.858 9.811 20 12 20c2.19 0 4.083-.143 5.4-.492c.663-.175 1.096-.382 1.345-.582c.218-.175.255-.304.255-.426c0-.18-.09-.489-.413-.899c-.316-.4-.804-.828-1.451-1.222C15.843 15.589 14.023 15 12 15m0-13a5 5 0 1 1 0 10a5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6"/></g></symbol><use href="#ai:mingcute:user-3-line"></use>  </svg> <span class="max-lg:hidden"> About </span> </a><a href="/links" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Links" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="links"> <svg width="1em" height="1em" data-icon="mingcute:link-3-line">   <symbol id="ai:mingcute:link-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M1 10a5 5 0 0 1 5-5h6a5 5 0 0 1 0 10a1 1 0 1 1 0-2a3 3 0 1 0 0-6H6a3 3 0 0 0-.75 5.906a1 1 0 0 1-.5 1.936A5 5 0 0 1 1 10m11 1a3 3 0 1 0 0 6h6a3 3 0 0 0 .75-5.905a1 1 0 0 1 .5-1.937A5.002 5.002 0 0 1 18 19h-6a5 5 0 0 1 0-10a1 1 0 1 1 0 2"/></g></symbol><use href="#ai:mingcute:link-3-line"></use>  </svg> <span class="max-lg:hidden"> Links </span> </a><a href="/search" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Search" data-path-name="blog/unsafe-rust-is-not-same-as-c/" data-href-base="search"> <svg width="1em" height="1em" data-icon="mingcute:search-3-line">   <symbol id="ai:mingcute:search-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.5 4a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13M2 10.5a8.5 8.5 0 1 1 15.176 5.262l3.652 3.652a1 1 0 0 1-1.414 1.414l-3.652-3.652A8.5 8.5 0 0 1 2 10.5M9.5 7a1 1 0 0 1 1-1a4.5 4.5 0 0 1 4.5 4.5a1 1 0 1 1-2 0A2.5 2.5 0 0 0 10.5 8a1 1 0 0 1-1-1"/></g></symbol><use href="#ai:mingcute:search-3-line"></use>  </svg> <span class="max-lg:hidden"> Search </span> </a> </nav> <div class="navbar-end" un-md="flex-grow flex items-baseline-last justify-center"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="18tXJb" component-url="/_astro/DarkLightToggle.6qHju4aH.js" component-export="default" renderer-url="/_astro/client.svelte.DMhakGtm.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;DarkLightToggle&quot;,&quot;value&quot;:true}" await-children><!--[--><button class="i-mingcute:moon-stars-line" aria-label="toggle theme"></button><!--]--><!--astro:end--></astro-island> </div> </header> <div class="main-and-footer__outer-container
        max-w-full min-h-screen overflow-x-hidden
        flex flex-grow flex-shrink flex-basis-200 xl:flex-grow-0 at-md:justify-center"> <div class="flex flex-col w-full max-w-200"> <main class="flex-grow relative p-4 md:pt-6 undefined">  <article> <h1 class="page-title text-3xl font-bold">  <span>Unsafe Rust 并不和 C 语言一样：从 Aliasing 谈起</span>  </h1> <div> <div class="markdown-body is-detailed"> <p lang="zh">在社区中你可能听到一种说法：在 <code>unsafe</code> 块里你可以像 C<sup><a href="#user-content-fn-%E7%94%B1%E4%BA%8E%E8%BF%99%E9%87%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E5%8C%BA%E5%88%86%EF%BC%8C%E4%B8%8B%E6%96%87%E7%9A%84%20c%20%E8%AF%AD%E8%A8%80%E6%88%96%E8%80%85%20c++%20%E8%AF%AD%E8%A8%80%E5%8F%AF%E8%83%BD%E8%AF%B4%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%A4%E8%80%85" id="user-content-fnref-%E7%94%B1%E4%BA%8E%E8%BF%99%E9%87%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E5%8C%BA%E5%88%86%EF%BC%8C%E4%B8%8B%E6%96%87%E7%9A%84%20c%20%E8%AF%AD%E8%A8%80%E6%88%96%E8%80%85%20c++%20%E8%AF%AD%E8%A8%80%E5%8F%AF%E8%83%BD%E8%AF%B4%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%A4%E8%80%85" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup> 语言那样写。然而事实并不是这样，C 语言的约束太差，事实上给了程序员太多“宽松”的东西。而在 Rust 里，unsafe 真的很 unsafe —— 当你要接管编译器为你做的安全保证，危险就暗藏在其中。</p>
<!-- more -->
<h2 id="从-aliasing-xor-mutability-说起">从 Aliasing XOR mutability 说起</h2>
<p>考虑这样一个函数</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, y</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 114</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 514</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">对于 C 语言新手程序员而言，这个函数看上去似乎等价于</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#E36209;--shiki-dark:#FFAB70">y</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 114</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 514</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">真的是这样吗？想想看，假如 <code>x</code> 和 <code>y</code> 实际上是指向同一个内存区域的不同名指针怎么办？一个 C 程序员可以很自然的回答： <code>x</code> 被先赋值为 <code>114</code>，然后又被赋值为 <code>514</code>，最后函数整体返回 <code>514</code>。</p>
<p lang="zh">然而并非如此。实际上，Rust 使用了严格的 aliasing 规则，根据 Rust 的规则，同一个变量永远不能有两个可变引用。这直接导致编译器的优化产生不同的结果。不考虑内联，编译器可以安全的假设，<code>x</code> 和 <code>y</code> 永远指向不同的内存地址。因此，在第 2 行赋值之后，编译器可以知道 <code>*x</code> 一定是 114, 从而直接返回 114.</p>
<p lang="zh">但如果我们在 <code>unsafe</code> 块中直接违背这个规则呢？这会导致 <em>Undefined Behavior</em>（未定义行为）。<strong>在 Rust 中，<code>unsafe</code> 块只是允许你绕过编译器的安全检查，但这并不意味着你可以违背 Rust 的 <em>Invariant</em>（不变式）假设</strong>。例如，Rust 的 <code>unsafe</code> 代码仍然需要遵循 Rust 的 aliasing 规则。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">#</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#24292E;--shiki-dark:#E1E4E8">inline</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">never</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, y</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 114</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 514</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 42</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> b </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 84</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ret </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    println!</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"a: {a}, b: {b}, ret: {ret}"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    unsafe</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> still_x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">as</span><span style="color:#D73A49;--shiki-dark:#F97583"> *mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // undefined behavior!</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ret </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;mut</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">still_x</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        println!</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"x: {x}, ret: {ret}"</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">在这个例子中，我们在 <code>unsafe</code> 块中创建了一个指向 <code>x</code> 的裸指针 <code>still_x</code>，然后将其作为第二个参数传递给 <code>alias_example</code> 函数。显然这违背了 aliasing 规则，因此产生一个 undefined behavior。严格来说，该程序编译运行的结果是不确定的。但是在 rustc 1.88.0 开启 <code>-O</code> （3 级优化）后，我们可以看到输出如下：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>a: 114, b: 514, ret: 114</span></span>
<span class="line"><span>x: 514, ret: 114</span></span></code></pre>
<div class="text-center"><small>
<p>Compiler Explorer 链接： <a href="https://godbolt.org/z/Y6s15h9eP">https://godbolt.org/z/Y6s15h9eP</a></p>
</small><p><small></small></p></div><p></p>
<p lang="zh">正如我们所料，编译器对 <code>alias_example</code> 函数进行了优化，虽然 <code>*x</code> 在函数中被第二次赋值为 514，但编译器接下来根本没有用到 <code>*x</code> 的值，而是直接返回了 114。生成的汇编代码如下：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">example:</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">alias_example:</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">h26925842407e8957:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     dword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     dword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">514</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="zh">而如果去掉 <code>-O</code> 优化选项，编译器就不会进行这样的优化了。将会正确的返回 514。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">example:</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">alias_example:</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">h26925842407e8957:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     qword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> - </span><span style="color:#005CC5;--shiki-dark:#79B8FF">16</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     qword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> - </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     dword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     dword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">514</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">dword</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="zh">这说明，如果你的代码中包含 <code>unsafe</code> 块，不同的优化级别下，可能会导致不同的行为。事实上，之前的代码实际上等价于使用了 <a href="https://en.cppreference.com/w/c/language/restrict.html"><code>restrict</code> 关键字</a> 的 C 代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int*</span><span style="color:#D73A49;--shiki-dark:#F97583"> restrict</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">int*</span><span style="color:#D73A49;--shiki-dark:#F97583"> restrict</span><span style="color:#E36209;--shiki-dark:#FFAB70"> y</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 114</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 514</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">在 <code>-O3</code> 编译选项下，生成如下的汇编</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">alias_example:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">514</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="zh">与 Rust 的行为一致。如果去掉 <code>restrict</code> 关键字，g++ 编译器（和任何一个成熟的编译器）都将默认 <code>x</code> 和 <code>y</code> 是可能 aliasing 的，因此不敢进行激进优化，只能按原样生成汇编代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">alias_example:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">514</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="zh">如果这个函数被大量执行，将会影响到性能。这不是一句玩笑。老练的 C 程序员都应该知道自从 C99 开始 <code>memcpy</code> 函数的类型签名就包含 <code>restrict</code> 关键字：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">void*</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> memcpy</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">void</span><span style="color:#D73A49;--shiki-dark:#F97583"> *restrict</span><span style="color:#E36209;--shiki-dark:#FFAB70"> dest</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#D73A49;--shiki-dark:#F97583"> *restrict</span><span style="color:#E36209;--shiki-dark:#FFAB70"> src</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">size_t</span><span style="color:#E36209;--shiki-dark:#FFAB70"> count</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<blockquote>
<p lang="en">The behavior is undefined if access occurs beyond the end of the dest array. If the objects overlap (which is a violation of the restrict contract)(since C99), the behavior is undefined. The behavior is undefined if either dest or src is an invalid or null pointer.</p>
</blockquote>
<p lang="zh">因为任何一个现代机器上，<code>memcpy</code> 都不是像 PDP-11 那样一个一个字节拷贝的，而是使用 SIMD 指令一次性拷贝多个字节。编译器需要知道 <code>dest</code> 和 <code>src</code> 不会 aliasing 才能进行这样的优化。你可以试一试用 Compiler Explorer 手动实现一个 <code>memcpy</code>，比较删掉 <code>restrict</code> 关键字后二者的影响。删掉 <code>restrict</code> 关键字后，编译器必须先比较两个指针是否相差在 <code>count</code> 直接以内（正如 <code>restrict</code> 保证），如果不是，才可以放心使用 SIMD，否则只能分情况讨论。对于 <code>memcpy</code> 这种被大量调用的函数，这一点点比较开销会导致可观察到的性能下降。</p>
<p lang="zh">而你没法保证写 C 语言的都是顶尖高手程序员，懂得时时刻刻加入 <code>restrict</code> 关键字，承担一旦用错就会出现未定义行为的后果。更多新手甚至连 <code>const</code> 也懒得或者不会使用。还有一些项目，代码质量明显堪忧，undefined behaviour 满天飞（虽然这也与 C/C++ 有一些不应该有的 undefined behaviour 有关），人们甚至总结出“不要开启优化选项，编译器会搞烂你的代码”的建议。——也可以理解，一些项目开出的工资没有办法雇佣能 C 语言期盼的不会犯错程序员。</p>
<p lang="zh">这也是为什么 Rust 明明比 C 语言抽象程度更高，却可能生成更高效的代码的原因。更多的约束允许编译器获得更多信息，进行更多优化。<strong>C 语言不只是不安全。它还慢。</strong> 事实上，在当今世界，C 语言反而正在拖慢代码的速度。<sup><a href="#user-content-fn-c-is-not-a-low-level-language" id="user-content-fnref-c-is-not-a-low-level-language" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup></p>
<blockquote>
<p lang="en">C also requires padding at the end of a structure because it guarantees no padding in arrays. Padding is a particularly complex part of the C specification and interacts poorly with other parts of the language. For example, you must be able to compare two structs using a type-oblivious comparison (e.g., memcmp), so a copy of a struct must retain its padding. In some experimentation, a noticeable amount of total runtime on some workloads was found to be spent in copying padding (which is often awkwardly sized and aligned).</p>
</blockquote>
<p lang="zh"><strong>类型系统并不只是一个繁琐的工具，只是用来保证人们想当然“一眼就能看出的”程序的安全性。它还给编译器更多信息，从而自动生成更高效的代码——而对于大多数程序员而言，并不会花费那么多时间在极致的性能优化上。</strong> 这很反一些程序员的直觉：它们认为越贴近底层、越像汇编、抽象程度越低的语言速度越快。它们会想当然地觉得，写汇编是最最快的，而 C 语言比汇编慢 10%，C++ 比 C 又慢 10%，Rust 又比 C++ 慢 10% ——这来自于错误的“前人经验”，在编译优化还没有那么成熟的时代，作为“稍微抽象了一点的汇编”的 C 语言确实通常能写出很高效的代码，而 C++ 等语言编译器不够聪明，无法进行足够的优化。而当今世界随着编译技术的发展，编译器已经可以进行非常复杂的优化，甚至可以在大多数情况下超越手写的优化代码。例如一些人津津乐道的“位运算加速技巧”在如今已经不是魔法，而是编译器的常规优化。</p>
<details class="beautiful-details">
<summary>
扩展阅读：一个 C 语言位运算加速被编译器自动实施的例子
</summary>
<p lang="zh">在算法题中，一个完全二叉树指的是叶子结点只能出现在最下层和次下层，且最下层的叶子结点集中在树的左部的二叉树。我们可以用一个数组直接存储完全二叉树，且节点用层次遍历编号，总是有编号为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 的节点，左子节点编号为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>i</mi></mrow><annotation encoding="application/x-tex">2i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord">2</span><span class="mord mathnormal">i</span></span></span></span>，右子节点编号为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2i + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>。因此我们可以用 <code>x * 2</code> 和 <code>x * 2 + 1</code> 来计算左子节点和右子节点的编号。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> &#x3C;stdio.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> left_child</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> right_child</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#D73A49;--shiki-dark:#F97583"> +</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> left_child_faster</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> right_child_faster</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#D73A49;--shiki-dark:#F97583"> |</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> get_most_rchild</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> maxn</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    while</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> maxn</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> right_child</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    int</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    int</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> lc1 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> left_child</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        lc2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> left_child_faster</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        rc1 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> right_child</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        rc2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> right_child_faster</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    printf</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">%d</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> %d</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> %d</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> %d</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, lc1, lc2, rc1, rc2</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">在信息学竞赛中，许多人会写 <code>x &#x3C;&#x3C; 1 | 1</code> 来加速完全二叉树叶子节点 index 的计算。然而现在这种技巧已经不再是魔法了。编译器会自动将 <code>x * 2 + 1</code> 优化为 <code>x &#x3C;&#x3C; 1 | 1</code>，你的技巧只不过是让自己读代码变得更困难，实际上对于两个函数，编译器完全会生成一模一样的代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">left_child:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">right_child:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">left_child_faster:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">right_child_faster:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">get_most_rchild:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">edi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     edi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">esi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        jge</span><span style="color:#24292E;--shiki-dark:#E1E4E8">     .L6</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">L7:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">eax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        jg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">      .L7</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">L6:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">LC0:</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        .string "%d %d %d %d"</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">main:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        sub</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     r8d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     ecx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     edx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     edi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, OFFSET </span><span style="color:#6F42C1;--shiki-dark:#B392F0">FLAT:</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.LC0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        call</span><span style="color:#24292E;--shiki-dark:#E1E4E8">    printf</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        add</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<div class="text-center"><small>
<p lang="zh">使用 g++ 15.1, <code>-O1</code> （相对很保守的优化）下的结果。</p>
<p lang="zh">可以看到，<code>xxx_child</code> 和 <code>xxx_child_faster</code> 生成的代码完全一样。而 <code>main</code> 和 <code>get_most_rchild</code> 函数内直接把函数自动内联，根本没有生成 <code>call</code> 指令，甚至 <code>main</code> 内结果也在编译期给出，没有任何运行时计算。</p>
</small><p><small></small></p></div><p></p>
</details>
<p lang="zh">但编译器优化也同时为 Rust 的 <code>unsafe</code> 块带来了更高风险。因为在 <code>unsafe</code> 块中，编译器不只是不再为你提供安全的保证，它还需要你将 Rust 的所有不变式熟记于心。这是人们随意说出“<code>unsafe</code> 块里像 C 语言一样写就好了”的时候所经常忽略的。</p>
<h2 id="编译器优化与-undefined-behavior">编译器优化与 Undefined Behavior</h2>
<p lang="zh">在 C 中一个经常被争论的点是编译器是否应该利用 undefined behavior 来进行激进的优化。C/C++ 语言的标准允许编译器在遇到 undefined behavior 时进行任意行为（比如发射核弹炸毁你的家 :P ），包括假定 undefined behaviour <strong>永远不会发生</strong>。（如果发生了，编译器作者假定程序员将会很乐意看到意外的行为）实际上 GCC 等编译器确实会在高的优化等级下，利用这一点进行优化。一个经典的例子是 signed integer overflow。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> foo</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#E36209;--shiki-dark:#FFAB70"> x</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#D73A49;--shiki-dark:#F97583"> </span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x;</span><span style="color:#6A737D;--shiki-dark:#6A737D"> // either true or UB due to signed overflow</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">如果一字一句的翻译这段代码，在许多平台，<code>int</code> 上溢时会按补码规则处理，得到一个负数值。因此，写这段代码的人会期望这个函数能“证明”一个整数将在当前架构下溢出。C 语言的前几节课讲到原码、反码、补码的时候，一些老师会用类似的代码作为例子向学生生动阐述溢出的效果（虽然应该不会开优化）。然而，signed integer overflow 实际上是 undefined behavior，因此编译器在激进优化时可以假定它永远不会发生。此时编译器会发现 <code>x + 1</code> 的结果永远不会小于 <code>x</code>，因此可以直接将其优化为 <code>return true;</code></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">foo:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="zh">如果学生不小心打开了优化开关——那它可能会很惊讶的发现代码的行为和老师的例子完全不一样。</p>
<p lang="zh">类似的例子还有很多。例如被许多人用来证明 “C 语言的优雅” 的著名算法，如《雷神之锤 III 竞技场》源代码中平方根倒数速算法之实例。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">float</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Q_rsqrt</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">float</span><span style="color:#E36209;--shiki-dark:#FFAB70"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    long</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x2, y;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#D73A49;--shiki-dark:#F97583"> float</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> threehalfs </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1.5</span><span style="color:#D73A49;--shiki-dark:#F97583">F</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    x2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> number </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0.5</span><span style="color:#D73A49;--shiki-dark:#F97583">F</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    y  </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> number;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    i  </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">long</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y;</span><span style="color:#6A737D;--shiki-dark:#6A737D">                       // evil floating point bit level hacking（对浮点数的邪恶位元hack）</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    i  </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> 0x</span><span style="color:#005CC5;--shiki-dark:#79B8FF">5f3759df</span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D">               // what the fuck?（这他妈的是怎么回事？）</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    y  </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">float</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">i;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    y  </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> y </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> threehalfs </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x2 </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> y </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> y </span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span><span style="color:#6A737D;--shiki-dark:#6A737D">   // 1st iteration （第一次迭代）</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">//  y  = y * ( threehalfs - ( x2 * y * y ) );   // 2nd iteration, this can be removed（第二次迭代，可以删除）</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> y;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="sv">实际上，这个代码是 undefined behaviour。C 的 strict aliasing 规则<sup><a href="#user-content-fn-https://en.cppreference.com/w/c/language/object.html#strict_aliasing" id="user-content-fnref-https://en.cppreference.com/w/c/language/object.html#strict_aliasing" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup>规定：</p>
<blockquote>
<p lang="en">Given an object with effective type T1, using an lvalue expression (typically, dereferencing a pointer) of a different type T2 is undefined behavior, unless:</p>
<ul lang="en">
<li>T2 and T1 are <a href="https://en.cppreference.com/w/c/language/compatible_type.html#Compatible_types">compatible types</a>.</li>
<li>T2 is cvr-qualified version of a type that is compatible with T1.</li>
<li>T2 is a signed or unsigned version of a type that is compatible with T1.</li>
<li>T2 is an aggregate type or union type type that includes one of the aforementioned types among its members (including, recursively, a member of a subaggregate or contained union).</li>
<li>T2 is a character type (char, signed char, or unsigned char).</li>
</ul>
<p>These rules control whether when compiling a function that receives two pointers, the compiler must emit code that re-reads one after writing through another:</p>
</blockquote>
<p lang="zh">因此，<code>int*</code> 和 <code>float*</code> 根本不应该指向同一块内存区域。这是 undefined behaviour。对于许多程序员而言这简直是荒谬的事情，因为它极大的限制了作为底层语言的 C 语言的能力。程序员会觉得，<code>float</code> 和 <code>int</code> 都是一样的大小，为什么不能直接将一个数字的位模式转换为另一个数字的位模式？这不是 C 语言的强项吗？</p>
<p lang="zh">但如果你站在编译器开发和优化者的角度，这个规则就变得非常有意义：当你看到 <code>int*</code> 和 <code>float*</code> 同时出现的时候，假定两者不会指向同一块内存区域，可以让编译器进行更激进的优化。因为如果两者指向同一块内存区域，编译器就必须在每次读取 <code>int</code> 或 <code>float</code> 时都重新从内存中读取，而不能直接使用寄存器中的值。让我们再回到最开始的 aliasing 例子。如果有以下代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> alias_example2</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">float</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#E36209;--shiki-dark:#FFAB70">y</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 114</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 514</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">编译器根本没法揣摩你的心意，尤其是像 C 这样的语言，你编译出来的代码还经常作为动态链接库，你根本不知道用户会传入什么。如果你不按 strict aliasing 就没法优化这段代码，说不定它会被大量调用，成为一个性能下降的节点呢？权衡之下，考虑到对同一块内存区域进行不同类型的解释是很罕见的情况，编译器更应该尝试将它优化成：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">alias_example2:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF">     eax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">114</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        mov</span><span style="color:#D73A49;--shiki-dark:#F97583">     DWORD</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> PTR </span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0x44008000</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        ret</span></span></code></pre>
<p lang="en">由于 undefined behaviour 广泛而常见，甚至在一些地方是难以绕开的（例如操作系统，Linux 的编译包含了 <code>-fno-strict-aliasing</code> 规则），有人认为<sup><a href="#user-content-fn-https://x.com/effectfully/status/1874144090327228518" id="user-content-fnref-https://x.com/effectfully/status/1874144090327228518" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup> GCC 等编译器 “using undefined behaviour in the C Standard as an excuse to fuck up their own compiler is what’s beyond demented” （拿 C 标准中的未定义行为作为借口来搞砸自己的编译器，简直是疯子干得出来的事情）</p>
<p lang="zh">然而我实际上不那么认为。难听点说，这是非常不负责任的行为。如果你不在乎性能而喜欢非常确定的行为可以用 Python 不是吗？为什么要用 C/C++ 为难自己？如果你在乎性能，就应该知道你在这里觉得无所谓的 5~10% 差异是别人可能刚需的。编译器作者不是只为你服务。这是一个多方权衡的 trade-off。</p>
<p lang="zh">实际上，我认为这种想法这是倒果为因了，应该说：是写编译器的人需要有足够强的假定来给他们进行优化，因此才将一些行为定义成 undefined behaviour.</p>
<blockquote>
<p lang="en">Defining a semantics with that property is not a simple task. A naive semantics, such as the one used in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mtext>Rust</mtext></msub></mrow><annotation encoding="application/x-tex">\lambda_{\text{Rust}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">λ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Rust</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, will give the example program<sup><a href="#user-content-fn-example" id="user-content-fnref-example" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup> a defined meaning and thus force the compiler to print 13. Compared to such a naive semantics, we have to “add” some undefined behavior to obtain the desired optimizations. But of course we should not add “too much” undefined behavior! We have to be careful that “desired” programs are still well-defined. This includes all safe programs, but should also include enough unsafe programs to still make unsafe Rust a useful language for implementing data structures such as Vec, and to minimize the chances of programmers accidentally running into undefined behavior. <sup><a href="#user-content-fn-rustbelt" id="user-content-fnref-rustbelt" data-footnote-ref="" aria-describedby="footnote-label">6</a></sup></p>
</blockquote>
<h2 id="unsafe-is-really-unsafe"><code>unsafe</code> is really unsafe</h2>
<p lang="zh"><strong>而你必须负起责任来。</strong></p>
<p lang="zh">Rust 与 C/C++ 的一个区别大概是后者有人惯着你。我敢说大部分以为自己会写 C/C++ 语言的人实际上都不懂得 C/C++ 语言的 undefined behavior —— 因此使用各种屎上糊屎的手段解决问题。例如极端地，禁止开优化。</p>
<p lang="zh">但是 Rust 不会让你这样。一大原因是，Rust debug 模式的产物确实太慢，与 Release 模式可以轻易到达 6 倍差距，人们不得不开优化。另一件事情来自 Rust 的设计哲学：Safe Rust 被期望是永远安全的，即使是初学者也不会写出段错误和未定义行为，如果尝试，那么编译器一定会警告。Safe Rust 的编写者从而能从底层的细节中解脱出来，专注关心业务逻辑，有时候则关心向编译器证明自己是对的。而一旦 Unsafe Rust 的编写者不够负责，信任链条就会在这里断裂，从而可能产生危险的漏洞。</p>
<p lang="zh">以 <a href="https://zhuanlan.zhihu.com/p/532496013">Unsafe Rust 随堂小测 - 知乎</a> 中给出的代码为例子，Unsafe Rust 的编写者必须非常熟练于找出代码可能被传入的多种边缘情况，否则，一不留神，便可能写出看似正确的 unsound 代码。</p>
<p lang="zh"><strong>例如第 1 题，初始化上的未定义行为。</strong></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/// !!!unsound!!!</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> bytes_of</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#005cc5;--shiki-dark:#79b8ff">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">u8</span><span style="color:#005cc5;--shiki-dark:#79b8ff">]</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> len</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> usize</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> core</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">mem</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">size_of</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> data</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> *const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u8</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">*const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">cast</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    unsafe</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">core</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">slice</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">from_raw_parts</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">data, len</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">编写者必须得想到多种情况：</p>
<ul lang="zh">
<li><code>T</code> 可能是 <code>MaybeUninit</code>，此时得到的 <code>&#x26;[u8]</code> 包含未初始化的内存，而读取未初始化内存是未定义行为</li>
<li><code>T</code> 可能包含对用户无感知的 padding，但是任何对 padding 的访问，包括读，都是未定义行为</li>
<li><code>T</code> 可能是包含内部可变性的类型（例如 <code>Cell</code>），此时对 <code>&#x26;T</code> 的访问不能保证指向的内存不变</li>
</ul>
<p lang="zh"><strong>第 6 题。对齐上的未定义行为。</strong></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/// !!!unsound!!!</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ffi_static_mut</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">'</span><span style="color:#6F42C1;--shiki-dark:#B392F0">static</span><span style="color:#D73A49;--shiki-dark:#F97583"> mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    unsafe</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> size</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> usize</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">mem</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">size_of</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> *mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> libc</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">malloc</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">size</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">cast</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_null</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            std</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">process</span><span style="color:#D73A49;--shiki-dark:#F97583">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">abort</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        &#x26;mut</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">ptr</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">显然这就是非常经典的在 unsafe rust 中当成 C 写——例如使用 malloc 函数。但是你们有没有想过，为什么 malloc 分配的指针犹如魔法一样，可以给任何类型使用，无需担心什么问题？尤其是对于初学者而言，它们甚至可能没有质疑过，为什么 malloc 可以给所有类型指针使用这件事情。malloc 能给所有类型使用似乎是理所当然的事情。</p>
<p lang="zh">——然而不是。这个函数体现了 Rust 和 C 不一样的地方，C 保证了所有类型都是由对齐已知的内置类型组合而来，因此 malloc 的规范里保证了得到的指针总是与任意 object type 都能对齐<sup><a href="#user-content-fn-returns%20a%20pointer%20that%20is%20suitably%20aligned%20for%20any%20object%20type%20with%20fundamental%20alignment.%20https://en.cppreference.com/w/c/memory/malloc" id="user-content-fnref-returns%20a%20pointer%20that%20is%20suitably%20aligned%20for%20any%20object%20type%20with%20fundamental%20alignment.%20https://en.cppreference.com/w/c/memory/malloc" data-footnote-ref="" aria-describedby="footnote-label">7</a></sup>。不能对齐有很多危害，例如现代 CPU 经常在 SIMD 指令上要求地址必须对齐。</p>
<p lang="zh">但是 Rust 没有这个保证。Rust 的类型可能包含更复杂的 align，如果传入的 <code>T</code> 需要更大的对齐，那么 <code>malloc</code> 返回的指针可能无法满足 <code>T</code> 的对齐要求。此时，返回的指针不能被安全的使用，这是未定义行为。</p>
<p lang="zh"><strong>第 7 题，恐慌安全</strong></p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/// !!!unsound!!!</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">pub</span><span style="color:#D73A49;--shiki-dark:#F97583"> fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> replace_with</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">v</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, f</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> impl</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> FnOnce</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    unsafe</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> *mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> v;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="zh">编写者必须考虑到 <code>f</code> 可能会 panic 的情况。此时，<code>ptr.write</code> 将会被打断，因此不会对 <code>v</code> 写入正确的值——而 panic 后被从 <code>v</code> 里面 move 出来的 <code>val</code> 将会被析构，因此外部的 <code>v</code> 还保留着 <code>val</code> 的同一个值，这将会导致双重析构，从而导致未定义行为。这通常会导致程序直接 segfault。</p>
<p lang="zh">这些例子都表明，编写 Unsafe Rust 代码的责任在于开发者，这不止是说说而已。开发者必须充分理解 Rust 的内存模型、计算机底层原理、体系结构、Rust 的各种不变式和内置 trait，以确保代码在任何时候都能保证安全性和正确性——或者产生一个编译错误。</p>
<p lang="zh">这种心智负担比全是 unsafe，全部要开发者自己承担的 C/C++ 某种意义上还要大。C/C++ 写出 bug 大可以怪调用者没遵守调用约定，但是 unsafe rust 的编写者因为自己的 unsafe 模块考虑不周全出了 bug，所有人都只会怪 unsafe 模块的编写者。</p>
<h2 id="结语">结语</h2>
<p lang="zh">经常有人说：对 C++ 和 Rust 极度了解，懂得该怎么驾驭 unsafe，适当的使用 unsafe 可以极大提高数据结构设计的灵活性</p>
<p lang="zh">那么问题是，谁才是对 C++ 和 Rust 极度了解呢？到底有多少人能做到“极度了解”呢？如果你是一个 C/C++ 程序员，你可能会觉得自己已经很了解了，但是你真的了解吗？大部分写 C/C++ 的人应该都远远称不上了解。尚且不说需要系统学习计算机底层的各种 alignment padding 需要编译原理来理解为什么的 aliasing 还有被誉为只有语言律师才能记得的各种 undefined behavior。就单说代码习惯，大多数人都能习惯性给每一个只要现在不变的类型写成 <code>const T &#x26;</code> 甚至加上 <code>__restrict</code> 吗？能在保证没有 exception 的时候习惯性加上 <code>noexcept</code> 吗？
这些都可能直接影响到性能，例如移动构造函数不加 <code>noexcept</code>，各种 STL 容器直接给你改成调用拷贝构造，影响性能。</p>
<p lang="zh">写这一篇文章大概就是为了感叹这样的问题。“在 unsafe 里就像 C 那样写就好”。然而 <code>unsafe</code> 并不是拿来给你在 Rust 的约束中找到一丝自由的 —— 它是允许经验丰富的人，在镣铐中跳舞，在遵守 Rust 的大量假设和不变式的同时，编写类型系统无法表达的那一部分——而你必须熟悉的是这一整套类型系统构筑起的约定、优化和安全边界。这是 Rust 的设计哲学。程序员不可信任，能在熟练掌握 unsafe 的终究是少数人。</p>
<p lang="zh">如果你没准备好去承担它们，那你也许根本不该碰 unsafe。</p>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label">脚注</h2>
<ol lang="en">
<li id="user-content-fn-%E7%94%B1%E4%BA%8E%E8%BF%99%E9%87%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E5%8C%BA%E5%88%86%EF%BC%8C%E4%B8%8B%E6%96%87%E7%9A%84%20c%20%E8%AF%AD%E8%A8%80%E6%88%96%E8%80%85%20c++%20%E8%AF%AD%E8%A8%80%E5%8F%AF%E8%83%BD%E8%AF%B4%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%A4%E8%80%85">
<p lang="zh">由于这里不需要特别区分，下文的 C 语言或者 C++ 语言可能说的是这两者 <a href="#user-content-fnref-%E7%94%B1%E4%BA%8E%E8%BF%99%E9%87%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E5%8C%BA%E5%88%86%EF%BC%8C%E4%B8%8B%E6%96%87%E7%9A%84%20c%20%E8%AF%AD%E8%A8%80%E6%88%96%E8%80%85%20c++%20%E8%AF%AD%E8%A8%80%E5%8F%AF%E8%83%BD%E8%AF%B4%E7%9A%84%E6%98%AF%E8%BF%99%E4%B8%A4%E8%80%85" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-c-is-not-a-low-level-language">
<p lang="fr">David Chisnall. 2018. C Is Not a Low-level Language: Your computer is not a fast PDP-11. Queue 16, 2 (March-April 2018), 18–30. <a href="https://doi.org/10.1145/3212477.3212479">https://doi.org/10.1145/3212477.3212479</a> <a href="#user-content-fnref-c-is-not-a-low-level-language" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-https://en.cppreference.com/w/c/language/object.html#strict_aliasing">
<p lang="en"><a href="https://en.cppreference.com/w/c/language/object.html#Strict_aliasing">https://en.cppreference.com/w/c/language/object.html#Strict_aliasing</a> <a href="#user-content-fnref-https://en.cppreference.com/w/c/language/object.html#strict_aliasing" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-https://x.com/effectfully/status/1874144090327228518">
<p lang="en"><a href="https://x.com/effectfully/status/1874144090327228518">https://x.com/effectfully/status/1874144090327228518</a> <a href="#user-content-fnref-https://x.com/effectfully/status/1874144090327228518" data-footnote-backref="" aria-label="Back to reference 4" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-example">
<p lang="zh">该论文中的 example 即本文开头的代码，但是数字有不同</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">fn</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> example</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, y</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;mut</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> i32</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 42</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<a href="#user-content-fnref-example" data-footnote-backref="" aria-label="Back to reference 5" class="data-footnote-backref">↩</a>
</li>
<li id="user-content-fn-rustbelt">
<p lang="en">Understanding and Evolving the Rust Programming Language <a href="#user-content-fnref-rustbelt" data-footnote-backref="" aria-label="Back to reference 6" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-returns%20a%20pointer%20that%20is%20suitably%20aligned%20for%20any%20object%20type%20with%20fundamental%20alignment.%20https://en.cppreference.com/w/c/memory/malloc">
<p lang="en">returns a pointer that is suitably aligned for any object type with fundamental alignment. <a href="https://en.cppreference.com/w/c/memory/malloc">https://en.cppreference.com/w/c/memory/malloc</a> <a href="#user-content-fnref-returns%20a%20pointer%20that%20is%20suitably%20aligned%20for%20any%20object%20type%20with%20fundamental%20alignment.%20https://en.cppreference.com/w/c/memory/malloc" data-footnote-backref="" aria-label="Back to reference 7" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section> </div>
    <div class="divider"></div>
    <p class="post-meta flex flex-wrap items-center gap-2 text-base-content/60 undefined" data-astro-cid-qtyrxm4s> <span class="date flex gap-1 items-center flex-shrink-0 text-sm" data-astro-cid-qtyrxm4s> <svg width="1em" height="1em" data-icon="mingcute:calendar-2-line">   <symbol id="ai:mingcute:calendar-2-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16 3a1 1 0 0 1 1 1v1h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2V4a1 1 0 0 1 2 0v1h6V4a1 1 0 0 1 1-1M8 7H5v2h14V7h-3zm-3 4v8h14v-8zm2 2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H16a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z"/></g></symbol><use href="#ai:mingcute:calendar-2-line"></use>  </svg> <time datetime="2025-07-21T08:24:40.000Z"> 2025-07-21 </time> </span> <span class="categories items" data-astro-cid-qtyrxm4s>  </span> <span class="tags items" data-astro-cid-qtyrxm4s> <a class="item" href="/tags/Code/" data-astro-cid-qtyrxm4s> <svg width="1em" height="1em" class="flex-shrink-0" data-astro-cid-qtyrxm4s="true" data-icon="mingcute:tag-line">   <symbol id="ai:mingcute:tag-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.537 2.164a3 3 0 0 1 2.244.727l.15.14l7.822 7.823a3 3 0 0 1 .135 4.098l-.135.144l-5.657 5.657a3 3 0 0 1-4.098.135l-.144-.135L3.03 12.93a3 3 0 0 1-.878-2.188l.011-.205l.472-5.185a3 3 0 0 1 2.537-2.695l.179-.021zm.308 1.989l-.127.003l-5.185.472a1 1 0 0 0-.888.787l-.017.118l-.472 5.185a1 1 0 0 0 .206.703l.083.095l7.823 7.823a1 1 0 0 0 1.32.083l.094-.083l5.657-5.657a1 1 0 0 0 .083-1.32l-.083-.094l-7.823-7.823a1 1 0 0 0-.671-.292M7.317 7.318a3 3 0 1 1 4.243 4.243a3 3 0 0 1-4.243-4.243m2.829 1.414a1 1 0 1 0-1.415 1.414a1 1 0 0 0 1.415-1.414"/></g></symbol><use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate" data-astro-cid-qtyrxm4s>Code</span> </a><a class="item" href="/tags/Rust/" data-astro-cid-qtyrxm4s> <svg width="1em" height="1em" viewBox="0 0 24 24" class="flex-shrink-0" data-astro-cid-qtyrxm4s="true" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate" data-astro-cid-qtyrxm4s>Rust</span> </a> </span> </p> 
    <div class="mt-8"><div class="comments-container"> <div id="gitalk-mainEl" data-uid="blog:unsafe-rust-is-not-same-as-c"></div> </div> <script type="module" src="/_astro/GitalkComment.astro_astro_type_script_index_0_lang.yHboq2cn.js"></script> </div> </div> </article>  </main> <footer> <div class="text-center mb-4 markdown-body"> <p>
&copy; 2025 Linca. All rights reserved.
</p> <p>
开业 <span id="BLOG_DAYS" data-first-date="1538918349000">2543</span> 天里，写下了 54 篇博客，2 篇页面，8 篇杂记，352905 字符。
</p> <p>
Powered by
<a href="https://astro.build" target="_blank" rel="noopener noreferrer">
Astro
</a>
and
<a href="https://github.com/Lhcfl/astro-theme-krypton2" target="_blank" rel="noopener noreferrer">
Krypton 2
</a>.
</p> </div> </footer> <script type="module">document.addEventListener("astro:page-load",()=>{const t=document.getElementById("BLOG_DAYS");if(t){const e=Date.now()-Number(t.dataset.firstDate),n=Math.floor(e/(1e3*60*60*24));t.textContent=n.toString()}});</script> </div> </div> <div class="sidebar__outer-container
              hidden print:hidden!
              flex-grow-0 flex-shrink max-w-70 has-sidebar:flex-shrink-0
              md:block md:relative md:has-sidebar:w-50
              lg:flex-shrink-0 lg:has-sidebar:w-70
              xl:w-70
              max-md:show-toc:z-10 max-md:show-toc:block max-md:show-toc:fixed max-md:show-toc:bottom-2 max-md:show-toc:w-full max-md:show-toc:max-w-full
              max-md:[body.show-toc_&]:animate-fade-in-up max-md:[body.show-toc_&]:animate-duration-300 max-md:[body.show-toc_&]:animate-ease-in-out
              max-md:[body.removing-toc_&]:animate-fade-out-down max-md:[body.removing-toc_&]:animate-duration-300 max-md:[body.removing-toc_&]:animate-ease-in-out"> <div class="sidebar__inner-container
          sticky top-0 bg-surface pt-6
          md:px-0 md:h-screen
          max-md:show-toc:px-2 max-md:show-toc:pt-4 max-md:show-toc:border-t max-md:show-toc:border-base-300 overflow-y-auto overflow-x-visible">  <div class="hidden has-sidebar:block min-[55rem]:block"> <div id="page-toc"> <ul class="timeline w-full"> <li class="toc-item group flex items-center gap-2 transition" un-text="base-content/60 [&.active]:secondary [&.active-now]:secondary+30" un-p="x-2 y-1" un-hover="bg-secondary/10 text-secondary" data-slug="从-aliasing-xor-mutability-说起"> <a href="#从-aliasing-xor-mutability-说起" class="flex items-center gap-1 w-full"> <div class="flex-shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">从 Aliasing XOR mutability 说起</span> </a> </li><li class="toc-item group flex items-center gap-2 transition" un-text="base-content/60 [&.active]:secondary [&.active-now]:secondary+30" un-p="x-2 y-1" un-hover="bg-secondary/10 text-secondary" data-slug="编译器优化与-undefined-behavior"> <a href="#编译器优化与-undefined-behavior" class="flex items-center gap-1 w-full"> <div class="flex-shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">编译器优化与 Undefined Behavior</span> </a> </li><li class="toc-item group flex items-center gap-2 transition" un-text="base-content/60 [&.active]:secondary [&.active-now]:secondary+30" un-p="x-2 y-1" un-hover="bg-secondary/10 text-secondary" data-slug="unsafe-is-really-unsafe"> <a href="#unsafe-is-really-unsafe" class="flex items-center gap-1 w-full"> <div class="flex-shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">unsafe is really unsafe</span> </a> </li><li class="toc-item group flex items-center gap-2 transition" un-text="base-content/60 [&.active]:secondary [&.active-now]:secondary+30" un-p="x-2 y-1" un-hover="bg-secondary/10 text-secondary" data-slug="结语"> <a href="#结语" class="flex items-center gap-1 w-full"> <div class="flex-shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">结语</span> </a> </li><li class="toc-item group flex items-center gap-2 transition" un-text="base-content/60 [&.active]:secondary [&.active-now]:secondary+30" un-p="x-2 y-1" un-hover="bg-secondary/10 text-secondary" data-slug="footnote-label"> <a href="#footnote-label" class="flex items-center gap-1 w-full"> <div class="flex-shrink-0 i-mingcute-add-circle-line group-[.active]:i-mingcute-check-circle-fill group-[.active-now]:i-mingcute-arrow-right-circle-fill"></div> <span class="ml-0">脚注</span> </a> </li> </ul> </div> <script type="module">function c(i,l){let t=null,e=!1;function o(...s){e?t=s:(i.apply(this,s),e=!0,setTimeout(()=>{e=!1,t&&(o.apply(this,t),t=null)},l))}return o}function n(i){const l=document.getElementById("page-toc");if(!l)return;const t=l.querySelectorAll("li");if(t.forEach(e=>e.classList.remove("active","active-now")),i!=null)for(const e of t){if(e.dataset.slug===i){e.classList.add("active-now");break}e.classList.add("active")}}const r=c(()=>{const i=document.querySelector(".markdown-body.is-detailed");if(!i)return;const l=Array.from(i.querySelectorAll("h1,h2,h3,h4,h5,h6").values()),t=l.findIndex(e=>e.getBoundingClientRect().y>110);t===0?n(null):t==-1?n(l.at(-1)?.id):n(l.at(t-1)?.id)},200);document.addEventListener("scroll",r);</script> </div> </div> </div>  </div> <div class="float-buttons fixed bottom-4 right-4 flex flex-col gap-2 print:hidden! text-base-content" aria-hidden="true"> <div class="opacity-0 translate-x-20 transition [body.is-scrolled_&]:opacity-100 [body.is-scrolled_&]:translate-x-0"> <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Scroll to top"> <div class="i-mingcute:arrow-up-line"></div> </button> </div> <div class="hidden has-sidebar:block md:hidden!"> <button onclick="document.body.classList.add('show-toc')" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Show TOC"> <div class="i-mingcute:list-check-fill"></div> </button> </div> </div> <script type="module">document.addEventListener("scroll",()=>{window.scrollY>100?document.body.classList.add("is-scrolled"):document.body.classList.remove("is-scrolled")});document.addEventListener("click",s=>{if(!document.body.classList.contains("show-toc"))return;let t=s.target;for(;t!=null;){if(t.classList.contains("float-buttons")||t.classList.contains("sidebar__inner-container"))return;t=t.parentElement}document.body.classList.remove("show-toc"),document.body.classList.add("removing-toc"),setTimeout(()=>{document.body.classList.remove("removing-toc")},280),s.stopPropagation()});</script> </body></html>