<!DOCTYPE html><html lang="zh-CN"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/webp" href="/_astro/logo.zcK9pHo2_CGMl6.webp"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Zero Calorie Drink Shop" href="https://lhcfl.github.io/rss.xml"><meta name="generator" content="Astro v5.18.0"><!-- Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://chinese-fonts-cdn.deno.dev"><link rel="preconnect" href="https://ik.imagekit.io" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://lhcfl.github.io/blog/write-your-own-std-optional-universal-ref-in-c/"><!-- Primary Meta Tags --><title>DIY std::optional: Using Universal References in C++ ⬝ Zero Calorie Drink Shop</title><meta name="title" content="DIY std::optional: Using Universal References in C++ ⬝ Zero Calorie Drink Shop"><meta name="description" content="This blog was written entirely because of the item Familiarize yourself with alternatives to overloading on universal references in Effcetive Morden C++. We start with a practical problem trying to emulate std::optional in C++14, because optional monads are a good paradigm for expressing values ​​that may be null, rather than assuming everything is maybe null which can easily break through the type system.
写下这篇文章完全是因为看到了 Effcetive Morden C++ 中的熟悉通用引用重载的替代方法。我们从一个现实的问题开始，即在 C++14 尝试模拟 std::optional，因为 optional 是表达可能为空的值的时候一个很好的范式，而不是假定一切都可能为 null 并轻易击穿类型系统。
"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://lhcfl.github.io/blog/write-your-own-std-optional-universal-ref-in-c/"><meta property="og:title" content="DIY std::optional: Using Universal References in C++ ⬝ Zero Calorie Drink Shop"><meta property="og:description" content="This blog was written entirely because of the item Familiarize yourself with alternatives to overloading on universal references in Effcetive Morden C++. We start with a practical problem trying to emulate std::optional in C++14, because optional monads are a good paradigm for expressing values ​​that may be null, rather than assuming everything is maybe null which can easily break through the type system.
写下这篇文章完全是因为看到了 Effcetive Morden C++ 中的熟悉通用引用重载的替代方法。我们从一个现实的问题开始，即在 C++14 尝试模拟 std::optional，因为 optional 是表达可能为空的值的时候一个很好的范式，而不是假定一切都可能为 null 并轻易击穿类型系统。
"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lhcfl.github.io/blog/write-your-own-std-optional-universal-ref-in-c/"><meta property="twitter:title" content="DIY std::optional: Using Universal References in C++ ⬝ Zero Calorie Drink Shop"><meta property="twitter:description" content="This blog was written entirely because of the item Familiarize yourself with alternatives to overloading on universal references in Effcetive Morden C++. We start with a practical problem trying to emulate std::optional in C++14, because optional monads are a good paradigm for expressing values ​​that may be null, rather than assuming everything is maybe null which can easily break through the type system.
写下这篇文章完全是因为看到了 Effcetive Morden C++ 中的熟悉通用引用重载的替代方法。我们从一个现实的问题开始，即在 C++14 尝试模拟 std::optional，因为 optional 是表达可能为空的值的时候一个很好的范式，而不是假定一切都可能为 null 并轻易击穿类型系统。
"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.Bk5rygI5.js"></script><link rel="stylesheet" href="/_astro/_static_page_.D_hEsS3a.css">
<link rel="stylesheet" href="/_astro/_static_page_.CVCZMPgC.css">
<link rel="stylesheet" href="/_astro/_static_page_.DUMM9sSp.css"><script type="module" src="/_astro/page.B5CPI74E.js"></script></head> <body class="overflow-y-scroll"> <div class="app bg-surface text-content md:flex lg:justify-center max-w-full">  <header class="flex-[0_0_auto] print:hidden flex sticky top-0 font-sans max-md:items-center max-md:justify-between max-md:w-full max-md:h-15 max-md:z-50 max-md:bg-surface max-md:px-2 max-lg:w-20 md:flex-col md:h-screen md:text-lg md:p-4 md:shrink-0 md:grow-0 max-md:border-b md:border-r border-base-300"> <a href="/" class="flex flex-col items-center gap-2 lg:mt-4"> <div class="nav-site-avatar avatar w-10 md:w-12 lg:hidden"> <img src="/_astro/logo.zcK9pHo2_CGMl6.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="100" height="100"> </div> <div class="nav-site-avatar avatar max-lg:hidden w-40"> <img src="/_astro/logo.zcK9pHo2_ZuqEup.webp" alt="Zero Calorie Drink Shop" loading="eager" decoding="async" fetchpriority="auto" width="512" height="512"> </div> <span class="nav-site-title text-lg font-bold max-lg:hidden">Zero Calorie Drink Shop</span> </a> <nav class="links flex items-center gap-2 text-lg md:flex-col md:pt-6 md:text-2xl lg:text-base"> <a href="/" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Home" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="/"> <svg width="1em" height="1em" data-icon="mingcute:home-3-line">   <symbol id="ai:mingcute:home-3-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.772 2.688a2 2 0 0 1 2.317-.099l.139.1l8.384 6.52c.721.561.37 1.692-.499 1.785l-.116.006H20v8a2 2 0 0 1-1.85 1.995L18 21H6a2 2 0 0 1-1.994-1.85L4 19v-8h-.997C2.09 11 1.671 9.892 2.3 9.285l.088-.076zM12 4.267L5.625 9.225c.229.185.375.468.375.785V19h3v-5a3 3 0 1 1 6 0v5h3v-8.99c0-.317.146-.6.375-.785zM12 13a1 1 0 0 0-1 1v5h2v-5a1 1 0 0 0-1-1"/></g></symbol><use href="#ai:mingcute:home-3-line"></use>  </svg> <span class="max-lg:hidden"> Home </span> </a><a href="/archives" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Archives" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="archives"> <svg width="1em" height="1em" data-icon="mingcute:archive-line">   <symbol id="ai:mingcute:archive-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16.586 3A2 2 0 0 1 18 3.586L20.414 6A2 2 0 0 1 21 7.414V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7.414A2 2 0 0 1 3.586 6L6 3.586A2 2 0 0 1 7.414 3zM19 9H5v10h14zm-7 1a1 1 0 0 1 1 1v3.186l.414-.414a1 1 0 1 1 1.414 1.414l-2.12 2.121a1 1 0 0 1-1.415 0l-2.121-2.121a1 1 0 1 1 1.414-1.414l.414.414V11a1 1 0 0 1 1-1m4.586-5H7.414l-2 2h13.172z"/></g></symbol><use href="#ai:mingcute:archive-line"></use>  </svg> <span class="max-lg:hidden"> Archives </span> </a><a href="/notes/1" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Notes" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="notes"> <svg width="1em" height="1em" data-icon="mingcute:notebook-line">   <symbol id="ai:mingcute:notebook-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M17 2c1.598 0 3 1.3 3 3v13c0 1.7-1.4 3-3 3H6c-1.054 0-2-.95-2-2V4c0-1.054.95-2 2-2zm0 2h-7v15h7c.513 0 1-.39 1-1V5c0-.513-.49-1-1-1M8 4H6v15h2z"/></g></symbol><use href="#ai:mingcute:notebook-line"></use>  </svg> <span class="max-lg:hidden"> Notes </span> </a><a href="/tags" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Tags" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="tags"> <svg width="1em" height="1em" data-icon="mingcute:tag-2-line">   <symbol id="ai:mingcute:tag-2-line" viewBox="0 0 24 24"><g fill="none"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.238 4.827a3 3 0 0 1 2.122.878l6.485 6.486a3 3 0 0 1 0 4.242l-4.243 4.243a3 3 0 0 1-4.242 0l-6.486-6.485a3 3 0 0 1-.878-2.122V7.327a2.5 2.5 0 0 1 2.5-2.5zm0 2H5.496a.5.5 0 0 0-.5.5v4.742a1 1 0 0 0 .292.707l6.486 6.486a1 1 0 0 0 1.414 0l4.243-4.243a1 1 0 0 0 0-1.414L10.945 7.12a1 1 0 0 0-.707-.293M7.531 9.362a1.5 1.5 0 1 1 2.121 2.122a1.5 1.5 0 0 1-2.121-2.122M11.652 2a3 3 0 0 1 2.122.878l7.192 7.193a1 1 0 0 1-1.414 1.414L12.36 4.29a1 1 0 0 0-.708-.29H7a1 1 0 0 1 0-2z"/></g></symbol><use href="#ai:mingcute:tag-2-line"></use>  </svg> <span class="max-lg:hidden"> Tags </span> </a><a href="/about" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="About" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="about"> <svg width="1em" height="1em" data-icon="mingcute:user-3-line">   <symbol id="ai:mingcute:user-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M12 13c2.396 0 4.575.694 6.178 1.672c.8.488 1.484 1.064 1.978 1.69c.486.615.844 1.351.844 2.138c0 .845-.411 1.511-1.003 1.986c-.56.45-1.299.748-2.084.956c-1.578.417-3.684.558-5.913.558s-4.335-.14-5.913-.558c-.785-.208-1.524-.506-2.084-.956C3.41 20.01 3 19.345 3 18.5c0-.787.358-1.523.844-2.139c.494-.625 1.177-1.2 1.978-1.69C7.425 13.695 9.605 13 12 13m0 2c-2.023 0-3.843.59-5.136 1.379c-.647.394-1.135.822-1.45 1.222c-.324.41-.414.72-.414.899c0 .122.037.251.255.426c.249.2.682.407 1.344.582C7.917 19.858 9.811 20 12 20c2.19 0 4.083-.143 5.4-.492c.663-.175 1.096-.382 1.345-.582c.218-.175.255-.304.255-.426c0-.18-.09-.489-.413-.899c-.316-.4-.804-.828-1.451-1.222C15.843 15.589 14.023 15 12 15m0-13a5 5 0 1 1 0 10a5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6"/></g></symbol><use href="#ai:mingcute:user-3-line"></use>  </svg> <span class="max-lg:hidden"> About </span> </a><a href="/links" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Friends" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="links"> <svg width="1em" height="1em" data-icon="mingcute:link-3-line">   <symbol id="ai:mingcute:link-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M1 10a5 5 0 0 1 5-5h6a5 5 0 0 1 0 10a1 1 0 1 1 0-2a3 3 0 1 0 0-6H6a3 3 0 0 0-.75 5.906a1 1 0 0 1-.5 1.936A5 5 0 0 1 1 10m11 1a3 3 0 1 0 0 6h6a3 3 0 0 0 .75-5.905a1 1 0 0 1 .5-1.937A5.002 5.002 0 0 1 18 19h-6a5 5 0 0 1 0-10a1 1 0 1 1 0 2"/></g></symbol><use href="#ai:mingcute:link-3-line"></use>  </svg> <span class="max-lg:hidden"> Friends </span> </a><a href="/search" role="button" class="header-link flex items-center justify-center gap-1 transition md:h-10 md:w-full md:hover:bg-primary/10 md:hover:text-primary" aria-label="Search" data-path-name="blog/write-your-own-std-optional-universal-ref-in-c/" data-href-base="search"> <svg width="1em" height="1em" data-icon="mingcute:search-3-line">   <symbol id="ai:mingcute:search-3-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.5 4a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13M2 10.5a8.5 8.5 0 1 1 15.176 5.262l3.652 3.652a1 1 0 0 1-1.414 1.414l-3.652-3.652A8.5 8.5 0 0 1 2 10.5M9.5 7a1 1 0 0 1 1-1a4.5 4.5 0 0 1 4.5 4.5a1 1 0 1 1-2 0A2.5 2.5 0 0 0 10.5 8a1 1 0 0 1-1-1"/></g></symbol><use href="#ai:mingcute:search-3-line"></use>  </svg> <span class="max-lg:hidden"> Search </span> </a> </nav> <div class="navbar-end md:flex-grow md:flex md:items-baseline-last md:justify-center"> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="18tXJb" component-url="/_astro/DarkLightToggle.DYSrvQvV.js" component-export="default" renderer-url="/_astro/client.svelte.DN8iM4l6.js" props="{}" ssr client="load" opts="{&quot;name&quot;:&quot;DarkLightToggle&quot;,&quot;value&quot;:true}" await-children><!--[--><button class="i-mingcute:moon-stars-line" aria-label="toggle theme"></button><!--]--><!--astro:end--></astro-island> </div> </header> <div class="main-and-footer__outer-container max-w-full min-h-screen overflow-x-hidden flex flex-grow flex-shrink flex-basis-180 xl:grow-0 at-md:justify-center"> <div class="flex flex-col w-full max-w-180"> <main class="grow relative p-4 md:pt-6 undefined">  <article> <h1 class="page-title text-3xl font-bold"> <span class="inline-flex items-center gap-1">   <span>DIY std::optional: Using Universal References in C++</span>  </span> </h1> <div> <div class="markdown-body is-detailed"> <p lang="en">This blog was written entirely because of the item <a href="https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item27.html"><em>Familiarize yourself with alternatives to overloading on universal references</em></a> in Effcetive Morden C++. We start with a practical problem trying to emulate <code>std::optional</code> in C++14, because optional monads are a good paradigm for expressing values ​​that may be null, rather than assuming everything is maybe null which can easily break through the type system.
写下这篇文章完全是因为看到了 Effcetive Morden C++ 中的<a href="https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item27.html">熟悉通用引用重载的替代方法</a>。我们从一个现实的问题开始，即在 C++14 尝试模拟 std::optional，因为 optional 是表达可能为空的值的时候一个很好的范式，而不是假定一切都可能为 null 并轻易击穿类型系统。</p>
<!-- more -->
<h2 id="simplest-approach">Simplest Approach</h2>
<p><strong>最简单的方法</strong></p>
<p>Obviously, a <code>std::optional&#x3C;T></code> is just a wrapper around two things: a <code>T</code> and a <code>bool</code> indicating whether <code>T</code> makes sense. We can easily write code like this:</p>
<p lang="zh">显然，一个 <code>std::optional&#x3C;T></code> 就是两个东西的包装：一个 <code>T</code> 和一个 <code>bool</code>，指示 T 是否有意义。我们可以很容易写下类似这样的代码：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> _None_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">static</span><span style="color:#D73A49;--shiki-dark:#F97583"> constexpr</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _None_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> None;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  T val;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> has_val;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _None_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">copy_from</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">move_from</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> x;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">x</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">x</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _None_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">The correctness of this is obvious, but it is not guaranteed to always compile. Obviously, <code>T</code> may have to be initialized with a meaningful parameter. This makes it impossible for our <code>option&#x3C;T></code> to be <code>None</code> in this case.
这样做的正确性当然是显然的，但是它不保证总是能编译。显然，<code>T</code> 有可能必须要一个有意义的参数来初始化。这使得对于这种情况，我们的 <code>option&#x3C;T></code> 根本无法为 <code>None</code>。</p>
<p lang="en">To solve this situation, we naturally think of pointers. A pointer can always be <code>nullptr</code> unless it is allocated with a real value, so we can rewrite our <code>option&#x3C;T></code> as a alias of <code>std::unique_ptr&#x3C;T></code>, adding an additional function <code>has_value() const</code> to check if it is <code>nullptr</code>, and a copy constructor. Such a class is easy to write, but it obviously still has disadvantages. The biggest disadvantage is that it needs to dynamically allocate memory, and on the heap, which seriously slows down our <code>option&#x3C;T></code>.
为了解决这个情况，我们自然会想到指针。指针在除非它被赋予一个真正的值之前可以一直是 <code>nullptr</code>，因此我们可以重写我们的 <code>option&#x3C;T></code> 为一个 <code>std::unique_ptr&#x3C;T></code> 的重命名，添加了一个额外的函数 <code>has_value() const</code> 判断它是不是 <code>nullptr</code>，并添加复制构造。这样的类很容易写出，但是它显然仍然有缺点。最大的缺点是它需要动态分配内存，而且是在堆上，这严重拖慢了我们的 <code>option&#x3C;T></code> 的速度。</p>
<p lang="en">To solve this problem, we will use <code>union</code>, a keyword inherited from C that allows multiple different types to coexist in the same memory position. But here <code>union</code> has another use: shielding the constructor and destructor of <code>T</code> and letting us manage it ourselves.
为了解决这个问题我们会使用 <code>union</code>，这个继承自 C 的关键字可以将多个不同类型共存于同一块内存空间。但在这里 <code>union</code> 另一个用途：屏蔽 <code>T</code> 的构造函数和析构函数，让我们自己托管它。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  union</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    T val;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> has_val;</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<p lang="en">In the above definition we put <code>T</code> in a <code>union</code>, which disables the constructor and destructor of <code>T</code>. Next, when we need to make sure that <code>option</code> actually has a <code>T</code>, we use <a href="https://en.cppreference.com/w/cpp/language/new">placement new</a> to construct <code>T</code> in place.
在上面的定义中我们把 <code>T</code> 放在 <code>union</code> 中，这禁用了 <code>T</code> 的构造和析构函数。接下来，当我们需要让 <code>option</code> 里面真的有 <code>T</code> 的时候，我们用 <a href="https://zh.cppreference.com/w/cpp/language/new">placement new</a> 原地构造 <code>T</code>。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">T </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> T </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> none_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">This looks perfect. In fact, it does roughly meet our needs, but is that enough? Suppose we have a custom class that needs to use <code>string</code> as a constructor. A <code>string</code> can certainly be constructed with <code>const char*</code>, so we naturally try to construct it with a string literal, like this. But does it really work as we wish? Guess if the following code will compile?
这看上去非常完美。实际上，它也确实能很大程度上满足了我们的需求，但是让我们精益求精。假如我们有一个自定义类，需要用到 <code>string</code> 作为构造函数。一个 <code>string</code> 当然可以用 <code>const char*</code> 来构造，所以我们自然而然地尝试用字符串字面量来构造它，就像这样。但是它真的能如我所愿吗？猜猜下面的代码会不会通过编译？</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> StringWrapper</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::string s;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  StringWrapper</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#E36209;--shiki-dark:#FFAB70"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">s</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">str</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  option</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">StringWrapper</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"123"</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // opt_test.cpp: In function 'int main()':</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // opt_test.cpp:123:45: error: no matching function for call to 'option&#x3C;StringWrapper>::option(const char [4])'</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">The answer is no! You need to explicitly construct a <code>StringWrapper</code> object to call the <code>option&#x3C;StringWrapper></code> constructor, because the <code>option&#x3C;StringWrapper></code> call function does not accept <code>const char [4]</code> as a parameter. C++ will not automatically “forward” it.
答案是否定的！你需要显式构造一个 <code>StringWrapper</code> 对象才能调用 <code>option&#x3C;StringWrapper></code> 的构造函数，因为 <code>option&#x3C;StringWrapper></code> 的调用函数并不能接受 <code>const char [4]</code> 作为参数。C++ s 不会自动“转发”它。</p>
<h2 id="universal-referances">Universal Referances</h2>
<p><strong>通用引用</strong></p>
<p lang="en">In order to forward the arguments to <code>T</code>’s constructor, as if our <code>option&#x3C;T></code> is actually <code>T</code>, we need to use perfect forwarding and universal references.
为了转发参数到 T 的构造函数，就像我们的 <code>option&#x3C;T></code> 实际上是 <code>T</code> 一样，我们需要用到完美转发和通用引用。</p>
<blockquote>
<p lang="en">In fact, “T&#x26;&#x26;” has two different meanings. One is rvalue reference, of course. Such references behave exactly the way you expect: they bind only to rvalues, and their primary raison d’être is to identify objects that may be moved from.
事实上，“T&#x26;&#x26;”有两种不同的意思。第一种，当然是右值引用。这种引用表现得正如你所期待的那样：它们只绑定到右值上，并且它们主要的存在原因就是为了识别可以移动操作的对象。
The other meaning for “T&#x26;&#x26;” is either rvalue reference or lvalue reference. Such references look like rvalue references in the source code (i.e., “T&#x26;&#x26;”), but they can behave as if they were lvalue references (i.e., “T&#x26;”). Their dual nature permits them to bind to rvalues (like rvalue references) as well as lvalues (like lvalue references). Furthermore, they can bind to const or non-const objects, to volatile or non-volatile objects, even to objects that are both const and volatile. They can bind to virtually anything. Such unprecedentedly flexible references deserve a name of their own. I call them universal references.
“T&#x26;&#x26;”的另一种意思是，它既可以是右值引用，也可以是左值引用。这种引用在源码里看起来像右值引用（即“T&#x26;&#x26;”），但是它们可以表现得像是左值引用（即“T&#x26;”）。它们的二重性使它们既可以绑定到右值上（就像右值引用），也可以绑定到左值上（就像左值引用）。 此外，它们还可以绑定到 const 或者 non-const 的对象上，也可以绑定到 volatile 或者 non-volatile 的对象上，甚至可以绑定到既 const 又 volatile 的对象上。它们可以绑定到几乎任何东西。这种空前灵活的引用值得拥有自己的名字。我把它叫做通用引用（universal references）。
<a href="https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item24.html">https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item24.html</a></p>
</blockquote>
<p lang="en">Assuming that everyone already understands how to write perfect forwarding, or you can also read the relevant description in Effective Morden C++, I won’t go into details here. The only problem with perfect forwarding is that it is not convenient to overload. It is easy to write a perfect forwarding constructor:
关于完美转发的写法假定大家都已经懂了，不懂的也可以看 Effective Morden C++ 相关的描述，这里不用多说了。完美转发唯一的问题是，它并不方便重载。我们很容易写出一个完美转发的构造函数：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#6A737D;--shiki-dark:#6A737D">  // &#x3C;---- Perfect forwarding</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">But these two overloads do not work as we expect. Compiling the following code will produce a compiler error:
但是这两个重载并不会像我们想象的那样工作。编译以下代码，它会产生编译器错误：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> StringWrapper</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::string s;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  StringWrapper</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">string</span><span style="color:#E36209;--shiki-dark:#FFAB70"> str</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">s</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">str</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">int</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  option</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">StringWrapper</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> test1;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  option</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">StringWrapper</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> test2</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">test1</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // In instantiation of 'option&#x3C;T>::option(Arg&#x26;&#x26;) [with Arg = option&#x3C;StringWrapper>&#x26;; T = StringWrapper]':</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  //    required from here</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  //  11 |   option&#x3C;StringWrapper> test2(test1);</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  //     |                                    ^</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // error: no matching function for call to 'StringWrapper::StringWrapper(option&#x3C;StringWrapper>&#x26;)'</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  //  23 |   option(Arg &#x26;&#x26;f) : val(std::forward&#x3C;Arg>(f)), has_val(true) {}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">How could that be! We did clearly declared <code>option(const option &#x26;b)</code>! But the overloading is not in this order. For more information on why the compiler overloads in this way, please see <a href="https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item26.html"><em>Avoid overloading on universal references</em></a>, which I will not go into here. In short, when encountering <code>option&#x3C;T></code>, the compiler will expand the universal reference above to:
怎么会呢！明明我们声明了 <code>option(const option &#x26;b)</code>! 但是重载并不是按这个顺序来的。关于编译器为什么会这样重载，请看 <a href="https://cntransgroup.github.io/EffectiveModernCppChinese/5.RRefMovSemPerfForw/item26.html">Avoid overloading on universal references</a>，这里不赘述。总而言之，遇到 <code>option&#x3C;T></code> 的时候，编译器会将上面那个通用引用展开为：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // template &#x3C;typename Arg> // &#x3C;-- Arg = option&#x26;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p>Obviously it is a better match than the copy constructor of <code>const option&#x26;</code>, so the compiler chooses it.
显然这相比于 <code>const option&#x26;</code> 的复制构造函数是一个更好的匹配，因此，编译器选择了它。</p>
<h3 id="use-enable_if">Use <code>enable_if</code></h3>
<p lang="da"><strong>使用 <code>std::enable_if</code></strong></p>
<p lang="en">(Of course, C++20 introduces better practices, namely concepts, but let’s use the features of C++14 to build our <code>option&#x3C;T></code>.)
（当然，C++20 引入了更好的做法即 concepts，但是我们这里先用 C++14 就有的功能来构建我们的 <code>option&#x3C;T></code>。）</p>
<blockquote>
<p lang="en"><code>std::enable_if</code> gives you a way to force compilers to behave as if a particular template didn’t exist. Such templates are said to be disabled. By default, all templates are enabled, but a template using <code>std::enable_if</code> is enabled only if the condition specified by <code>std::enable_if</code> is satisfied.
<code>std::enable_if</code> 可以给你提供一种强制编译器执行行为的方法，像是特定模板不存在一样。这种模板被称为被禁止（disabled）。默认情况下，所有模板是启用的（enabled），但是使用 <code>std::enable_if</code> 可以使得仅在 <code>std::enable_if</code> 指定的条件满足时模板才启用。</p>
</blockquote>
<p lang="en">I am not going to explain the syntax of <code>enable_if</code> here. In short, after introducing <code>enable_if</code>, our constructors become like this;
这里不打算解释 <code>enable_if</code> 的语法。总而言之，引入 <code>enable_if</code> 后，我们的构造函数变成了这样；</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">enable_if</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">expression</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> , </span><span style="color:#D73A49;--shiki-dark:#F97583">bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">type</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p lang="en">Where the <em>expression</em> is an expression that only when it is true will the overloaded function be called. Obviously, it is appropriate to call perfect forwarding only when <code>Args</code> can be used to construct <code>T</code> (for convenience, we do not consider meaningless duplicate types like <code>option&#x3C;option&#x3C;T>></code>). Therefore, the expanded code becomes obvious (to highlight the type traits, I use <code>not</code> instead of <code>!</code>):
其中 <em>expression</em> 是某个表达式，只有在它成立的时候，这个重载函数才会被调用。显然，我们只有在 <code>Args</code> 可以用来构造 <code>T</code> 的时候调用完美转发是合适的（为了方便，我们不考虑像 <code>option&#x3C;option&#x3C;T>></code> 这样无意义的重复类型）因此，详细的写法就变得显然了（为了突出 type traits 的关系，我使用了 <code>not</code> 代替 <code>!</code>）：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ...</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::is_base_of</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">T</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">                      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">remove_reference_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">remove_const_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">enable_if_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_constructible</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> and</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                                 not </span><span style="color:#6F42C1;--shiki-dark:#B392F0">OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                             bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> none_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ...</span></span></code></pre>
<h2 id="code-and-tests">Code and Tests</h2>
<p><strong>代码和测试</strong></p>
<p lang="en">Finally, our self-made <code>std::optional&#x3C;T></code> using universal references is ready! Here is what the code looks like:
最后，我们使用通用引用的自制 <code>std::optional&#x3C;T></code> 就写好了！代码长这样：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#pragma</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> once</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> &#x3C;type_traits></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> &#x3C;utility></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">struct</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> none_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">constexpr</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> none_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> None;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  union</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    T val;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> has_val;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> release</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      val.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">~T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::is_base_of</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">T</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">                      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">remove_reference_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">remove_const_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">enable_if_t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_constructible</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> and</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                                 not </span><span style="color:#6F42C1;--shiki-dark:#B392F0">OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                             bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> none_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">b</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">none_t</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    release</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">enable_if_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_constructible</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value </span><span style="color:#D73A49;--shiki-dark:#F97583">and</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                       not</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                   option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">fwd</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#5a32a3;--shiki-dark:#b392f0">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">enable_if_t</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value, option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">fwd</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fwd.has_val;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd.val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  constexpr</span><span style="color:#D73A49;--shiki-dark:#F97583"> bool</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> has_value</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#D73A49;--shiki-dark:#F97583"> noexcept</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> has_val; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> val; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">value</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> val; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  T</span><span style="color:#D73A49;--shiki-dark:#F97583"> *operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  T </span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#D73A49;--shiki-dark:#F97583"> *operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">-</span><span style="color:#6F42C1;--shiki-dark:#B392F0">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  ~option</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">release</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span></code></pre>
<p lang="en">What a <em>lovely</em> code! Comparing to the real <code>std::optional</code>, the behavior of our’s is very consistent in allocation and moving or copying.
多么<em>优美</em>的代码！将它和真正的 <code>std::optional</code> 对比，无论是分配内存还是移动/拷贝的行为都非常一致。</p>
<h2 id="and-c20">And C++20</h2>
<p><strong>以及 C++20</strong></p>
<p lang="en">When using C++20, a great improvement is that we can use <em>concepts</em> to replace complex and difficult <code>std::enable_if</code> to get more semantic error prompts. So the original <code>std::enable_if</code> can be replaced with <code>requires</code>, like this:
当我们使用 C++20 的时候，一个很大的特点是我们可以用 <em>concepts</em> 来替换复杂难用的 <code>std::enable_if</code> 并且获得更加语义化的错误提示。所以原先的 <code>std::enable_if</code> 可以替换成 <code>requires</code>，就像这样：</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583"> template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    requires</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_constructible</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value </span><span style="color:#D73A49;--shiki-dark:#F97583">and</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">             not</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Arg </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">f</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">true</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> none_t</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">false</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#6F42C1;--shiki-dark:#B392F0">has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">move</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">b.val</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">none_t</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    release</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    requires</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_constructible</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value </span><span style="color:#D73A49;--shiki-dark:#F97583">and</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">             not</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">fwd</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">has_val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#e36209;--shiki-dark:#ffab70">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      new</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">val</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#5a32a3;--shiki-dark:#b392f0">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#5a32a3;--shiki-dark:#b392f0">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    </span><span style="color:#e36209;--shiki-dark:#ffab70">}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">typename</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    requires</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> OptionConstructable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">::value</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  option</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;operator</span><span style="color:#6F42C1;--shiki-dark:#B392F0">=</span><span style="color:#005cc5;--shiki-dark:#79b8ff">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Arg</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x26;&#x26;</span><span style="color:#E36209;--shiki-dark:#FFAB70">fwd</span><span style="color:#005cc5;--shiki-dark:#79b8ff">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    has_val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> fwd.has_val;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    val </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">forward</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#24292E;--shiki-dark:#E1E4E8">fwd.val</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#005CC5;--shiki-dark:#79B8FF">this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p>What a <em>simpler</em> code!
真是<em>简单</em>了不少呢！</p>
<h2 id="and-rust">And Rust</h2>
<p><strong>以及 Rust</strong></p>
<p lang="en">After writing a lot of C++ dark magic, let’s see how Rust’s <code>Option</code> is defined.
写完了丰富的 C++ 黑魔法，让我们看看 rust 的 <code>Option</code> 是怎么定义的。</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Option</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> </span><span style="color:#005cc5;--shiki-dark:#79b8ff">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    None</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Some</span><span style="color:#e36209;--shiki-dark:#ffab70">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#e36209;--shiki-dark:#ffab70">)</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005cc5;--shiki-dark:#79b8ff">}</span></span></code></pre>
<p>Fuck.
操。</p>
<h2 id="conclusion-结论">Conclusion 结论</h2>
<p lang="gl">Don’t use C++.
别用 C++</p> </div>
    <div class="divider"></div>
    <p class="post-meta flex flex-wrap items-center gap-2 text-base-content/60"> <span class="date flex gap-1 items-center shrink-0 text-sm"> <svg width="1em" height="1em" data-icon="mingcute:calendar-2-line">   <symbol id="ai:mingcute:calendar-2-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M16 3a1 1 0 0 1 1 1v1h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2V4a1 1 0 0 1 2 0v1h6V4a1 1 0 0 1 1-1M8 7H5v2h14V7h-3zm-3 4v8h14v-8zm2 2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H12a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2zm3-2a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H16a1 1 0 0 1-1-1m1 2a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2z"/></g></symbol><use href="#ai:mingcute:calendar-2-line"></use>  </svg> <time datetime="2024-12-22T12:04:41.000Z"> 2024/12/22 </time> </span> <span class="flex flex-wrap max-w-full overflow-hidden text-ellipsis gap-2"> <a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Note/"> <svg width="1em" height="1em" class="shrink-0" data-icon="mingcute:tag-line">   <symbol id="ai:mingcute:tag-line" viewBox="0 0 24 24"><g fill="none" fill-rule="evenodd"><path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z"/><path fill="currentColor" d="M10.537 2.164a3 3 0 0 1 2.244.727l.15.14l7.822 7.823a3 3 0 0 1 .135 4.098l-.135.144l-5.657 5.657a3 3 0 0 1-4.098.135l-.144-.135L3.03 12.93a3 3 0 0 1-.878-2.188l.011-.205l.472-5.185a3 3 0 0 1 2.537-2.695l.179-.021zm.308 1.989l-.127.003l-5.185.472a1 1 0 0 0-.888.787l-.017.118l-.472 5.185a1 1 0 0 0 .206.703l.083.095l7.823 7.823a1 1 0 0 0 1.32.083l.094-.083l5.657-5.657a1 1 0 0 0 .083-1.32l-.083-.094l-7.823-7.823a1 1 0 0 0-.671-.292M7.317 7.318a3 3 0 1 1 4.243 4.243a3 3 0 0 1-4.243-4.243m2.829 1.414a1 1 0 1 0-1.415 1.414a1 1 0 0 0 1.415-1.414"/></g></symbol><use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Note</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/C++/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">C++</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/Code/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">Code</span> </a><a class="tag text-sm flex items-center gap-1 smooth-underline truncate" href="/tags/双语/"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="shrink-0" data-icon="mingcute:tag-line">   <use href="#ai:mingcute:tag-line"></use>  </svg> <span class="truncate">双语</span> </a> </span> </p>
    <div class="mt-8 border-t border-t-base-300 pt-4"><div class="comments-container"> <div id="gitalk-mainEl" data-uid="blog:write-your-own-std-optional-universal-ref-in-c"></div> </div> <script type="module" src="/_astro/GitalkComment.astro_astro_type_script_index_0_lang.C8Q7p-gl.js"></script> </div> </div> </article>  </main> <footer> <div class="text-center mb-4 markdown-body font-sans text-xs!"> <p>
&copy; 2026 Linca. All rights reserved.
</p> <p>
开业 <span id="BLOG_DAYS" data-first-date="1538918349000">2700</span> 天里，写下了 56 篇博客，2 篇页面，9 篇杂记，357221 字符。
</p> <p>
Powered by
<a href="https://astro.build" target="_blank" rel="noopener noreferrer">
Astro
</a>
and
<a href="https://github.com/Lhcfl/astro-theme-krypton2" target="_blank" rel="noopener noreferrer">
Krypton 2
</a>.
</p> </div> </footer> <script type="module">document.addEventListener("astro:page-load",()=>{const t=document.getElementById("BLOG_DAYS");if(t){const e=Date.now()-Number(t.dataset.firstDate),n=Math.floor(e/(1e3*60*60*24));t.textContent=n.toString()}});</script> </div> </div> <div class="sidebar__outer-container hidden print:hidden! grow-0 shrink max-w-70 has-sidebar:shrink-0 md:block md:relative md:has-sidebar:w-50 lg:shrink-0 lg:has-sidebar:w-70 animate-duration-300! animate-ease-in-out! xl:w-70 uno-e8c0g7"> <div class="sidebar__inner-container sticky top-0 bg-surface pt-6 md:px-0 md:h-screen max-md:show-toc:px-2 max-md:show-toc:pt-4 max-md:show-toc:border-t max-md:show-toc:border-base-300 overflow-y-auto overflow-x-visible">  <div class="hidden has-sidebar:block min-[55rem]:block">  </div> </div> </div>  </div> <div class="float-buttons fixed bottom-4 right-4 flex flex-col gap-2 print:hidden! text-base-content" aria-hidden="true"> <div class="opacity-0 translate-x-20 transition [body.is-scrolled_&]:opacity-100 [body.is-scrolled_&]:translate-x-0"> <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Scroll to top"> <div class="i-mingcute:arrow-up-line"></div> </button> </div> <div class="hidden has-sidebar:block md:hidden!"> <button onclick="document.body.classList.add('show-toc')" class="rounded-full p-4 text-lg md:text-xl bg-surface border-base-300 border" aria-label="Show TOC"> <div class="i-mingcute:list-check-fill"></div> </button> </div> </div> <script type="module">document.addEventListener("scroll",()=>{window.scrollY>100?document.body.classList.add("is-scrolled"):document.body.classList.remove("is-scrolled")});document.addEventListener("click",s=>{if(!document.body.classList.contains("show-toc"))return;let t=s.target;for(;t!=null;){if(t.classList.contains("float-buttons")||t.classList.contains("sidebar__inner-container"))return;t=t.parentElement}document.body.classList.remove("show-toc"),document.body.classList.add("removing-toc"),setTimeout(()=>{document.body.classList.remove("removing-toc")},280),s.stopPropagation()});</script> </body></html>